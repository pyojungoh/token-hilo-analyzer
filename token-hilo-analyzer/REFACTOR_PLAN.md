# 토큰하이로우 분석기 — 서버 리팩터링 전체 계획

> **목적**: 현재 한 파일(app.py)에 몰린 코드를 역할별로 나누고, 수정 시 다른 부분에 지장이 나지 않도록 구조를 바꾼다.  
> **원칙**: 기존 서비스는 유지한 채, **새 서버 프로젝트**를 따로 만들어 완성 후 전환한다.

---

## 1. 현재 상태 vs 목표 상태

| 구분 | 현재 | 목표 |
|------|------|------|
| 서버 | app.py 한 파일에 Flask + DB + HTML + CSS + JS | 서버 로직 / 라우트 / DB / 템플릿 / 정적파일 분리 |
| 수정 시 | 한 곳 수정이 다른 기능에 영향 | 역할별 파일이라 수정 범위가 명확 |
| 배포 | 단일 app | 동일 동작의 새 앱으로 전환 후 기존 중단 |

---

## 2. 전체 일정(단계)

| 단계 | 내용 | 완료 기준 |
|------|------|------------|
| **0** | 계획·환경 정리 | 이 문서 확정, 새 폴더/저장소 결정 |
| **1** | 새 서버 골격 생성 | Flask 앱 실행, DB 연결, 헬스체크 동작 |
| **2** | 디렉터리·역할 구조 확정 | 폴더 구조 문서화, 각 파일 역할 정의 |
| **3** | DB·설정 분리 | db.py, config 분리, 기존과 동일 스키마/연결 |
| **4** | API·라우트 이전 | 기존 API와 동일 응답으로 라우트만 분리 |
| **5** | 템플릿·정적파일 분리 | HTML/CSS/JS를 파일로 분리, 화면 동일 |
| **6** | 기능 동치 검증 | 체크리스트로 기존 대비 동작 일치 확인 |
| **7** | 배포·전환 | 새 서버 배포, 도메인 전환, 기존 서버 중단 |

---

## 3. 새 서버 디렉터리 구조(목표)

```
token-hilo-analyzer-v2/   (또는 서브폴더)
├── app.py                 # Flask 앱 생성만, 라우트 등록만
├── config.py             # 설정·상수 (DB URL, 가중치 0.6/0.25/0.15 등)
├── requirements.txt
├── Procfile
├── db/
│   ├── __init__.py
│   ├── connection.py     # get_db_connection, statement_timeout
│   └── init_tables.py     # 테이블 생성, 컬럼 추가
├── routes/
│   ├── __init__.py
│   ├── results.py        # /api/results
│   ├── prediction.py     # /api/prediction-history, /api/win-rate-buckets
│   ├── calc.py           # /api/calc-state
│   └── pages.py          # / (메인 HTML)
├── services/             # 비즈니스 로직 (DB/라우트와 분리)
│   ├── __init__.py
│   ├── prediction.py     # get_prediction_history, save_prediction_record, _blended_win_rate
│   ├── results.py        # 결과 조회·캐시
│   └── calc.py           # 계산기 상태 저장/조회
├── templates/
│   └── index.html        # 메인 페이지 (기존 app.py 내 HTML 이전)
├── static/
│   ├── css/
│   │   └── main.css
│   └── js/
│       └── main.js
└── REFACTOR_PLAN.md      # 이 문서
```

- **규칙**: 한 파일은 한 역할. 라우트는 “요청 받기 → 서비스 호출 → 응답 반환”만 담당.

---

## 4. 단계별 상세 작업

### 0단계: 계획·환경 정리

- [ ] 이 계획서(REFACTOR_PLAN.md)를 팀/본인 기준으로 최종 확인
- [ ] 새 서버 위치 결정: 같은 저장소의 `v2/` 폴더 vs 새 저장소
- [ ] DB: 기존 DB 그대로 쓸지, 전환용 DB를 따로 둘지 결정 (권장: 같은 DB로 새 서버만 연결)

### 1단계: 새 서버 골격

- [ ] 새 디렉터리 생성
- [ ] Flask 앱, `requirements.txt`, `Procfile` 작성
- [ ] `DATABASE_URL` 등 환경 변수만으로 DB 연결
- [ ] `/health` 또는 `/` 200 응답 확인
- [ ] Railway/배포 환경이 있다면 새 서버만 별도 서비스로 배포 (기존 서버는 그대로)

### 2단계: 디렉터리·역할 구조

- [ ] 위 “디렉터리 구조”대로 폴더·빈 파일 생성
- [ ] 각 파일에 “이 파일의 역할” 주석 1줄씩 작성
- [ ] `app.py`에서 라우트를 `routes/`로 나누어 등록만 하도록 수정

### 3단계: DB·설정 분리

- [ ] `config.py`: DB URL, 가중치(0.6, 0.25, 0.15), 기타 상수
- [ ] `db/connection.py`: `get_db_connection`, 타임아웃 처리
- [ ] `db/init_tables.py`: 기존과 동일한 `prediction_history`, `calc_sessions`, `current_pick` 등 테이블·컬럼
- [ ] 앱 기동 시 `init_tables` 한 번 호출해 스키마 맞춤

### 4단계: API·라우트 이전

- [ ] 기존 app.py의 API 목록 정리 (예: `/api/results`, `/api/prediction-history`, `/api/calc-state`, `/api/win-rate-buckets` 등)
- [ ] 라우트별로 `routes/*.py`에 옮기고, 실제 로직은 `services/*.py`에서 처리
- [ ] 요청/응답 형식은 **기존과 완전 동일**하게 유지 (클라이언트 수정 없이 전환 가능하도록)

### 5단계: 템플릿·정적파일 분리

- [ ] app.py 안의 HTML 문자열 → `templates/index.html`로 이동
- [ ] CSS → `static/css/main.css`
- [ ] JS → `static/js/main.js`
- [ ] Flask에서 `render_template`, `send_from_directory`로 제공
- [ ] 화면·동작이 기존과 동일한지 눈으로 확인

### 6단계: 기능 동치 검증

- [ ] 아래 “동작 체크리스트”를 만들어, 기존 서버 vs 새 서버 비교
- [ ] 가능하면 주요 API는 스크립트/브라우저로 같은 요청 → 같은 응답인지 확인

### 7단계: 배포·전환

- [ ] 새 서버를 프로덕션 URL에 배포 (또는 임시 URL에서 충분히 검증)
- [ ] 도메인/트래픽을 새 서버로 전환
- [ ] 모니터링 후 문제 없으면 기존 서버 중단

---

## 5. 동작 체크리스트(예시)

전환 전에 “기존과 동일한지” 확인할 때 사용할 수 있는 목록이다. 필요에 따라 항목을 늘리거나 줄인다.

- [ ] 메인 페이지(/) 로드 시 카드·그래프·예측 영역이 그대로 나온다
- [ ] 결과 데이터(/api/results) 응답 형식·필드가 기존과 같다
- [ ] 예측 기록 저장/조회(/api/prediction-history)가 동작한다
- [ ] 합산승률 구간(/api/win-rate-buckets) 응답이 기존과 같다
- [ ] 계산기 상태(/api/calc-state) GET/POST가 동작한다
- [ ] DB에 저장된 예측·계산기 상태를 새 서버에서 그대로 읽고 쓴다
- [ ] 로그인/세션을 쓰는 부분이 있다면, 전환 후에도 동일하게 동작한다

---

## 6. 위험·롤백

| 위험 | 대응 |
|------|------|
| 새 서버에서 버그 발견 | 기존 서버는 그대로 두었으므로, 도메인만 다시 기존으로 되돌리면 복구 |
| DB 스키마가 달라짐 | 새 서버는 기존과 동일한 스키마만 사용. 컬럼 추가는 기존과 같은 마이그레이션 방식 유지 |
| 환경 변수/설정 누락 | config.py와 배포 환경 변수 목록을 문서에 적어 두고, 체크리스트에 “환경 변수 확인” 추가 |

---

## 7. 진행 시 유의사항

1. **한 번에 한 단계만**: 단계 완료 기준을 만족한 뒤 다음 단계로 넘긴다.
2. **기존 서버 수정 최소화**: 리팩터링은 새 서버에서만 수행하고, 기존 app.py는 버그 수정·필수 패치만 적용한다.
3. **이 계획서 갱신**: 단계를 바꾸거나 폴더 구조를 수정하면 이 MD 파일을 함께 수정해 두면, 나중에 계획대로 진행할 때 실패를 줄일 수 있다.

---

*마지막 수정: 계획 초안 작성*
