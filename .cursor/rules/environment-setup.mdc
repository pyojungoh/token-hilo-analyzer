---
description: 분석기·자동배팅 매크로가 쓰는 배포 환경 (다중 Railway 프로젝트). 수정 시 이 구성을 항상 참고할 것.
globs: app.py, auto-betting-macro/**/*.py, **/railway*, **/Procfile
alwaysApply: true
---

# 배포·환경 구성 (수정 시 항상 체크)

이 프로젝트는 **동일 GitHub repo**를 기준으로 **여러 Railway 프로젝트**를 쓸 수 있는 구조다. 서버/DB/매크로 URL을 바꿀 때 아래를 지키면 된다.

---

## 1. 사용 중인 환경 예시

- **기존(메인)**: 별도 Railway 프로젝트 또는 tgame365 등 — 하나의 분석기 + 하나의 DB.
- **추가(다른 사용자용)**: 새 Railway 프로젝트 하나 더.
  - 결과 페이지: `https://web-production-28c2.up.railway.app/results`
  - **매크로용 Analyzer URL(루트만)**: `https://web-production-28c2.up.railway.app` (끝에 `/results` 넣지 말 것)

같은 repo를 두 프로젝트에 연결해 두면, **코드 한 번 수정·푸시** 시 두 쪽 모두 자동 배포된다.

---

## 2. Railway 새 프로젝트 시 DB가 비어 있을 때

- **원인**: web 서비스에 `DATABASE_URL`이 없거나, 앱이 아직 한 번도 기동하지 않음.
- **조치**  
  1. web 서비스 **Variables**에 `DATABASE_URL` 설정:  
     - **권장**: Variable reference로 같은 프로젝트의 Postgres → `DATABASE_URL` 또는 `DATABASE_PRIVATE_URL` 참조 (`${{Postgres.DATABASE_URL}}` 등).  
     - 또는 연결 문자열 직접 입력 (내부 주소: `postgres.railway.internal:5432`).
  2. 변수 저장 후 재배포되고, **앱 URL 한 번 접속**하면 `app.py`의 `init_database()`가 실행되어 `game_results`, `prediction_history`, `current_pick` 등 테이블이 **자동 생성**됨.
- **테이블은 있는데 데이터가 없음** → 새 인스턴스라서 정상. 사용하면서 쌓이면 됨.

---

## 3. 자동배팅 매크로와 Analyzer URL

- 매크로는 **Analyzer URL** 입력값을 **베이스**로 사용해 `{베이스}/api/current-pick` 등으로 요청한다.
- **API는 앱 루트**에 있으므로:
  - **올바름**: `https://web-production-28c2.up.railway.app` (루트만)
  - **잘못됨**: `https://web-production-28c2.up.railway.app/results` → `/results/api/current-pick` 호출되어 404 가능.
- **수정 시**: `emulator_macro.py` 등에서 기본 URL·placeholder를 바꾸거나 새 환경을 문서화할 때, **매크로에는 루트 URL만** 사용하도록 유지할 것. 결과 페이지 주소(`/results`)와 API 베이스(루트)를 혼동하지 말 것.

---

## 4. 수정 시 체크 리스트

다음과 같은 수정을 할 때는 이 구성을 반드시 확인할 것.

| 수정 대상 | 체크할 것 |
|-----------|------------|
| API 경로 (`/api/current-pick`, `/api/results` 등) | 앱 루트 기준이라 매크로/클라이언트는 **도메인 루트 + 경로**만 사용. `/results`를 prefix로 붙이지 말 것. |
| DB 연결·테이블 생성 (`app.py` `init_database`) | 새 프로젝트는 `DATABASE_URL`만 맞으면 기동 시 테이블 자동 생성. 이 로직 삭제·비활성화하지 말 것. |
| 환경 변수 (`DATABASE_URL`, `BASE_URL` 등) | Railway web 서비스 Variables에 설정. 새 프로젝트는 Postgres 참조 또는 직접 URL. |
| 매크로 기본 URL·문서 | Analyzer URL = **루트만**. 결과 페이지 = **루트 + /results**. README/가이드에 둘 구분해 적을 것. |
| 계산기·current_pick | 서버별로 DB가 다르므로, 프로젝트 A 매크로 → 프로젝트 A URL, 프로젝트 B 매크로 → 프로젝트 B URL 사용. |

---

이 규칙을 수정·확장할 때는 “매크로 Analyzer URL = 루트”, “새 DB = DATABASE_URL + 앱 기동 시 테이블 자동 생성”, “다중 프로젝트 = 같은 repo, 서버별로 다른 도메인”을 유지한다.
