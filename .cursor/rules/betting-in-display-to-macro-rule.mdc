---
description: 계산기 배팅중 → 자동배팅기 즉시 전달 규칙. 코딩 전 반드시 파악할 것.
globs: app.py, auto-betting-macro/**/*.py
alwaysApply: true
---

# 배팅중 → 자동배팅기 즉시 전달 (절대 규칙)

**코딩하기 전에 이 규칙을 반드시 파악할 것.**

## 기본 원칙

1. **계산기 상단 "배팅중"**에 픽이 들어오자마자 **자동배팅기에도 즉시** 픽이 전달되어야 한다.
2. **회차·픽·배팅중 금액** 검증 후 **바로 ADB로 배팅**해야 한다.
3. **배팅중 금액 = 계산기 표 1열(배팅중 행)과 동일** — `getBetForRound(id, curRound)` 출처만 사용.

## 데이터 흐름 (변형 금지)

```
[서버 calc 상태]  _server_calc_effective_pick_and_amount → suggested_amount (마틴·멈춤 반영)
       │
       ├─ POST /api/current-pick-relay 시: 서버 금액으로 덮어쓰기 (클라이언트 값 무시)
       ├─ _push_current_pick_from_calc (스케줄러): 결과 반영 시 relay 캐시 갱신
       ▼
[서버 relay 캐시]  _update_current_pick_relay_cache ← 서버 계산 금액만 사용
       │
       │  매크로 GET /api/current-pick-relay?calculator=N (25ms 폴링)
       ▼
[자동배팅기]  (회차, 픽, 금액) 1회 수신 → 검증 → ADB 배팅
```

## 금액 정확도 규칙

- **금액은 서버가 직접 계산** — `_server_calc_effective_pick_and_amount` 결과만 사용. 클라이언트 동기화 지연·마틴 승 후 잘못된 금액 방지.

## 안정화 규칙 (들어왔다 보류떴다 방지)

- **POST null/보류 수신 시**: 캐시 덮어쓰지 않음. 유효 (round, pick, amount) 있을 때만 캐시 갱신.
- **스케줄러**: 캐시에 유효 픽 있고 서버 회차가 같거나 낮으면 덮어쓰지 않음 (`_should_skip_relay_cache_update`).
- **매크로 표시**: null 수신 시 기존 유효 표시 유지. 새 유효 픽(round, pick, amount) 있을 때만 갱신.

## 수정 시 금지

- `_display_best_amount`를 배팅 금액으로 사용 금지 (표시용만)
- `suggested_amount` 외 다른 필드로 금액 유도 금지

---

상세: `docs/AUTO_BETTING_AMOUNT_RULES.md`, `docs/AUTO_BETTING_DATA_FLOW.md`
