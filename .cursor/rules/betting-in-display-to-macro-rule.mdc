---
description: 계산기 배팅중 → 자동배팅기 즉시 전달 규칙. 코딩 전 반드시 파악할 것.
globs: app.py, auto-betting-macro/**/*.py
alwaysApply: true
---

# 배팅중 → 자동배팅기 즉시 전달 (절대 규칙)

**코딩하기 전에 이 규칙을 반드시 파악할 것.**

## 기본 원칙

1. **계산기 상단 "배팅중"**에 픽이 들어오자마자 **자동배팅기에도 즉시** 픽이 전달되어야 한다.
2. **회차·픽·배팅중 금액** 검증 후 **바로 ADB로 배팅**해야 한다.
3. **배팅중 금액 = 계산기 표 1열(배팅중 행)과 동일** — `getBetForRound(id, curRound)` 출처만 사용.

## 데이터 흐름 (변형 금지)

```
[서버 1행]  _get_calc_row1_bundle(c) → (round, pick, amount)
[클라이언트 상단]  getCalcResult.currentBet → suggested_amount (POST)
       │
       ├─ POST: 1행 vs 상단 일치 시에만 relay 갱신. 불일치 시 갱신 안 함.
       ├─ _push_current_pick_from_calc (스케줄러): 1행 번들 relay
       ▼
[서버 relay 캐시]  검증된 값만 저장
       │
       │  매크로 GET/WebSocket
       ▼
[자동배팅기]  받은 금액 그대로 표시·배팅 (lock 없음)
```

## 금액 정확도 규칙

- **이중 검증** — 1행(서버) vs 상단(클라이언트) 금액이 같을 때만 relay 갱신. 불일치 시 스케줄러 값 유지.
- **매크로** — `_display_amount_locked` 없음. 받은 값 그대로 사용.

## 안정화 규칙 (들어왔다 보류떴다 방지)

- **POST null/보류 수신 시**: 캐시 덮어쓰지 않음. 유효 (round, pick, amount) 있을 때만 캐시 갱신.
- **스케줄러**: 캐시에 유효 픽 있고 서버 회차가 같거나 낮으면 덮어쓰지 않음 (`_should_skip_relay_cache_update`).
- **매크로 표시**: null 수신 시 기존 유효 표시 유지. 새 유효 픽(round, pick, amount) 있을 때만 갱신.

## 수정 시 금지

- `_display_best_amount`를 배팅 금액으로 사용 금지 (표시용만)
- `suggested_amount` 외 다른 필드로 금액 유도 금지

---

상세: `docs/AUTO_BETTING_AMOUNT_RULES.md`, `docs/AUTO_BETTING_DATA_FLOW.md`
