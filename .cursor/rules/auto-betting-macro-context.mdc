---
description: 자동배팅 매크로 작업 맥락. 새 채팅에서 매크로 이어서 작업할 때 참고.
globs: auto-betting-macro/**/*.py, app.py
alwaysApply: false
---

# 자동배팅 매크로 작업 맥락

## 구조 요약

- **Relay 캐시**: `_current_pick_relay_cache` — DB 없이 메모리에서 즉시 반환
- **GET** `/api/current-pick-relay?calculator=N` → 매크로 폴링
- **POST** `/api/current-pick-relay` → 웹 계산기가 픽/금액 갱신
- **서버 스케줄러**: `_push_current_pick_from_calc` → `_update_current_pick_relay_cache` 직접 호출

## 배팅중 금액 정확도 (절대 규칙)

- **배팅중 금액 = 계산기 표 1열과 동일** (`getBetForRound` 출처)
- **POST 수신**: 클라이언트 값 사용. **단, 마틴 끝 후** 서버에 직전 회차 결과가 있으면 `pending_bet_amount`로 덮어씀 (잘못된 마틴 금액 방지)
- **매크로**: `suggested_amount`만 배팅에 사용. `_display_best_amount`는 표시용만.
- **마틴 승 후**: 반드시 초기 금액으로 리셋. 마틴 금액이 이어져 배팅되면 안 됨.
- **상세**: `docs/AUTO_BETTING_AMOUNT_RULES.md`, `docs/AUTO_BETTING_DATA_FLOW.md` 참고

## relay 캐시

- **스케줄러**: 0.2초마다 `_update_current_pick_relay_cache` 호출
- **웹 POST**: relay 캐시 **항상** 즉시 갱신 (배팅중 픽 들어오자마자 매크로 전달 — 상세: `betting-in-display-to-macro-rule.mdc`)

## 완료된 작업

- 매크로 표시 안정화: `(회차, 픽, 금액)`이 2회 연속 동일할 때만 UI 갱신 (`emulator_macro.py`)
- relay 캐시: POST 즉시 갱신 + 스케줄러 0.2초마다 갱신 (매크로 즉시 수신)

## 배팅 흐름 (절대 규칙)

- **금액 넣고 바로 레드/블랙 탭.** 키보드 닫기 없음.
- **BACK 키 절대 사용 금지** — 앱 나가기 원인. 원래 BACK 명령 없었음.
- 순서: 금액 칸 탭 → 금액 입력 → 레드 또는 블랙 탭 (끝)

## 마틴게일 승/패 판정 (절대 규칙)

- **승/패 판정은 `h["result"]` 우선.** `_merge_results_into_history`에서 pick_color vs actual_color(색상 비교)로 설정.
- `pred == act`는 card_15 변환 오류 시 틀릴 수 있으므로, result가 있으면 반드시 result 사용.
- **승이면 step=0(1배), 패/조커면 step+1.** 승 후 다음 배팅은 반드시 1배(초기금액).

## 좌표 기능 (금액 테스트·탭 튕김 방지)

- **get_window_rect_at**: `GetClientRect` + `ClientToScreen` 사용 — LDPlayer 클라이언트 영역(실제 화면) 기준. `GetWindowRect`(창 전체) 사용 금지.
- **emulator_macro.py, emulator_macro_light.py, coord_picker.py** 세 곳 모두 동일한 `get_window_rect_at` 구현 유지.
- **coord_picker**: 클릭 시 창 자동 감지 → `window_left/top/width/height`, `coord_spaces`, `device_width/height` 저장. 매크로와 형식 호환.
- **금액 테스트**: 보정 좌표가 기기 범위 밖이면 탭 전에 에러 반환(튕김 방지). 배팅금액 칸 2회 탭 후 입력으로 포커스 확보.
- **_apply_window_offset**: `raw_coords` 포함 기기 범위 클램프 적용 — 밖으로 튕김 방지.

## 관련 파일

| 파일 | 역할 |
|------|------|
| `app.py` | relay API, `_update_current_pick_relay_cache`, `_push_current_pick_from_calc` |
| `emulator_macro.py` | 풀 매크로 UI, 폴링, 표시 안정화 |
| `emulator_macro_light.py` | 경량 매크로 |
| `coord_picker.py` | 좌표 찾기 (창 자동 감지, emulator_coords.json 저장) |
