---
description: 자동배팅 매크로 작업 맥락. 새 채팅에서 매크로 이어서 작업할 때 참고.
globs: auto-betting-macro/**/*.py, app.py
alwaysApply: false
---

# 자동배팅 매크로 작업 맥락

## 구조 요약

- **Relay 캐시**: `_current_pick_relay_cache` — DB 없이 메모리에서 즉시 반환
- **GET** `/api/current-pick-relay?calculator=N` → 매크로 폴링
- **POST** `/api/current-pick-relay` → 웹 계산기가 픽/금액 갱신
- **서버 스케줄러**: `_push_current_pick_from_calc` → `_update_current_pick_relay_cache` 직접 호출

## 배팅중 금액 정확도 (절대 규칙)

- **배팅중 금액 = 계산기 표 1열과 동일** (`getBetForRound` 출처)
- **POST 수신**: 클라이언트가 보낸 `suggested_amount` **그대로** DB 저장. 서버가 `pending_bet_amount`로 덮어쓰지 않음.
- **GET 반환**: DB 회차 ≥ relay 회차이면 **DB 우선** (분석기→POST가 relay보다 빠름)
- **상세**: `docs/AUTO_BETTING_DATA_FLOW.md` 참고

## relay 캐시

- **스케줄러**: 0.2초마다 `_update_current_pick_relay_cache` 호출
- **웹 POST**: relay 캐시 갱신 안 함. DB만 저장.

## 완료된 작업

- 매크로 표시 안정화: `(회차, 픽, 금액)`이 2회 연속 동일할 때만 UI 갱신 (`emulator_macro.py`)
- relay 캐시 단일 소스: 서버 스케줄러만 갱신, 웹 POST는 relay 갱신 제외

## 좌표 기능 (금액 테스트·탭 튕김 방지)

- **get_window_rect_at**: `GetClientRect` + `ClientToScreen` 사용 — LDPlayer 클라이언트 영역(실제 화면) 기준. `GetWindowRect`(창 전체) 사용 금지.
- **emulator_macro.py, emulator_macro_light.py, coord_picker.py** 세 곳 모두 동일한 `get_window_rect_at` 구현 유지.
- **coord_picker**: 클릭 시 창 자동 감지 → `window_left/top/width/height`, `coord_spaces`, `device_width/height` 저장. 매크로와 형식 호환.
- **금액 테스트**: 보정 좌표가 기기 범위 밖이면 탭 전에 에러 반환(튕김 방지). 배팅금액 칸 2회 탭 후 입력으로 포커스 확보.
- **_apply_window_offset**: `raw_coords` 포함 기기 범위 클램프 적용 — 밖으로 튕김 방지.

## 관련 파일

| 파일 | 역할 |
|------|------|
| `app.py` | relay API, `_update_current_pick_relay_cache`, `_push_current_pick_from_calc` |
| `emulator_macro.py` | 풀 매크로 UI, 폴링, 표시 안정화 |
| `emulator_macro_light.py` | 경량 매크로 |
| `coord_picker.py` | 좌표 찾기 (창 자동 감지, emulator_coords.json 저장) |
