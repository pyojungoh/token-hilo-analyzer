---
description: 계산기(가상 배팅) 동작 기준 — 가이드 반영용
globs: app.py, **/CALCULATOR_GUIDE.md
alwaysApply: true
---

# 계산기 가이드 (규칙)

계산기 관련 코드를 수정할 때 **docs/CALCULATOR_GUIDE.md**를 기준으로 동작이 일치하는지 확인한다. 요약만 아래에 둔다.

## 목표

- 계산기는 브라우저/PC가 꺼져도 **서버에서 계속 동작**하며, 켜서 보면 정확한 계산이 되어 있어야 함.
- 계산기 표·설정은 **calc_sessions(서버)** 에 저장되고, 클라이언트는 복원 시 서버 상태를 따름.

## 계산기 표 (저장·표시)

| 항목 | 규칙 |
|------|------|
| 픽 | 배팅중 픽 + 반픽/승률반픽/연패반픽 옵션 적용. 예측기표에는 예측픽만 저장, 계산기 history에는 배팅 픽 저장. |
| 경고승률 | 해당 회차 시점의 **실제 경고 합산승률**(blended)을 history에 `warningWinRate`로 저장·표시. |
| 배팅금액 | 회당 서버에 저장. 멈춤 시 0, 표시는 `-`. |
| 수익 | 매 회 서버에서 계산해 history에 저장. 정지할 때까지 누적. |
| 승패 | **멈춤이어도** 승/패/조커는 항상 기록. `no_bet`/`betAmount=0`만 적용. |

## 설정 옵션

- **반픽**: 예측픽 반대로 배팅.
- **승률 반픽**: 실제 경고 합산승률이 설정값 **이하**일 때 반대픽.
- **연패 반픽**: 3연패 이상·실제 경고 합산승률이 설정값 **이하**일 때 반대픽. (연패 = 조커·패 포함 연속 손실)
- **멈춤**: **최근 15회 계산기 승률**이 설정 % **이하**일 때 배팅 멈춤, 배팅금액 `-`, **승패는 반드시 기록**.
- **멈춤 + 마틴**: 마틴 중에는 **연패 후 승**으로 한 사이클이 끝난 뒤에만 멈춤 검사.
- **시간**: 설정 시간 종료 시 배팅 정지.
- **목표**: 순익이 목표 도달 시 즉시 정지. 게임 중 변경 가능.

## 버튼

- 실행 / 정지 / 리셋(계산기 표·서버 상태 초기화).

---

상세 내용·구현 위치는 **docs/CALCULATOR_GUIDE.md** 참고. 수정 시 가이드 위반이 없도록 할 것.
