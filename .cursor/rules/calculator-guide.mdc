---
description: 계산기(가상 배팅) 동작 기준 — 가이드 반영용
globs: app.py, **/CALCULATOR_GUIDE.md
alwaysApply: true
---

# 계산기 가이드 (규칙)

계산기 관련 코드를 수정할 때 **docs/CALCULATOR_GUIDE.md**를 기준으로 동작이 일치하는지 확인한다. 요약만 아래에 둔다.

## 목표

- 계산기는 브라우저/PC가 꺼져도 **서버에서 계속 동작**하며, 켜서 보면 정확한 계산이 되어 있어야 함.
- 계산기 표·설정은 **calc_sessions(서버)** 에 저장되고, 클라이언트는 복원 시 서버 상태를 따름.

## 계산기 표 (저장·표시)

| 항목 | 규칙 |
|------|------|
| 픽 | 배팅중 픽 + 반픽/승률반픽/연패반픽 옵션 적용. 예측기표에는 예측픽만 저장, 계산기 history에는 배팅 픽 저장. |
| 경고승률 | 해당 회차 시점의 **실제 경고 합산승률**(blended)을 history에 `warningWinRate`로 저장·표시. |
| 배팅금액 | 회당 서버에 저장. 멈춤 시 0, 표시는 `-`. |
| 수익 | 매 회 서버에서 계산해 history에 저장. 정지할 때까지 누적. |
| 승패 | **멈춤이어도** 승/패/조커는 항상 기록. `no_bet`/`betAmount=0`만 적용. |

## 설정 옵션

- **반픽**: 예측픽 반대로 배팅.
- **승률 반픽**: 실제 경고 합산승률이 설정값 **이하**일 때 반대픽.
- **연패 반픽**: N연패 이상(N 선택 가능, 기본 4)·실제 경고 합산승률이 설정값 **이하**일 때 반대픽. (연패 = 조커·패 포함 연속 손실)
- **50회 추세반픽**: 최근 50회(조커 제외) 승률이 **50% 미만**일 때 반대 픽. 계산기 픽에만 적용, 예측기표 무관.
- **멈춤**: **최근 15회 계산기 승률**이 설정 % **이하**일 때 배팅 멈춤, 배팅금액 `-`, **승패는 반드시 기록**.
- **멈춤 + 마틴**: 마틴 사용 시 **연패 후 승**이 나오면 15회 승률 무관 **즉시 멈춤**(다음 회차부터 배팅 안 함). 비마틴 시에만 15회 승률 이하일 때 멈춤.
- **시간**: 설정 시간 종료 시 배팅 정지.
- **목표**: 순익이 목표 도달 시 즉시 정지. 게임 중 변경 가능.

## 버튼

- 실행 / 정지 / 리셋(계산기 표·서버 상태 초기화).

---

## 옵션 추가 시 안전 수칙 (필수)

새 계산기 옵션을 넣을 때 **저장/복원이 깨지지 않도록** 반드시 지킬 것.

1. **저장·불러오기 구조는 건드리지 않기**
   - `session_id`, `localStorage`, `GET/POST /api/calc-state` 흐름, `get_calc_state`/`save_calc_state`, `calc_sessions` 사용 방식은 **그대로** 둔다.
   - **추가만** 하는 것: 저장 payload에 **필드 하나** 더 넣고, 서버는 그 필드를 받아 `state_json`에 포함했다가 그대로 내려주기. 기존 필드 타입/이름 변경·삭제 금지.

2. **서버 기본값 처리**
   - 예전에 저장된 세션에는 새 필드가 없을 수 있음. 서버에서 **없으면 기본값**(예: `false`)으로 처리해, 기존 저장본이 깨지지 않게 한다.

3. **UI는 계산기 설정 한 블록만**
   - 새 옵션용 체크박스/셀렉트는 **계산기 1·2·3 설정 테이블**에 한 줄(한 블록)만 추가. 예측기표·prediction_history·메인 예측기 픽·결과 정렬·회차 표시 쪽은 **절대 수정하지 않는다.**

4. **로직은 “계산기 픽 결정” 한 곳만**
   - 반픽/승률반픽/연패반픽을 적용하는 **서버 스케줄러**와 **클라이언트 픽 표시**에서만 새 옵션 분기 추가. 회차 반영, 결과 정렬, prediction_history 저장, current_pick 저장 로직은 **수정하지 않는다.**

5. **검증**
   - 옵션 끈 상태로 저장 → 새로고침 → 복원 확인. 옵션 켠 상태로 저장 → 새로고침 → 복원 확인. 기존 옵션(반픽·승률반픽·연패반픽 등)은 그대로 두고 새 옵션만 켜/끄며 저장·새로고침 반복해, 다른 항목이 리셋되지 않는지 확인.

---

상세 내용·구현 위치는 **docs/CALCULATOR_GUIDE.md** 참고. 수정 시 가이드 위반이 없도록 할 것.
