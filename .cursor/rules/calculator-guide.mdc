---
description: 계산기(가상 배팅) 동작 기준 — 가이드 반영용
globs: app.py, **/CALCULATOR_GUIDE.md
alwaysApply: true
---

# 계산기 가이드 (규칙)

계산기 관련 코드를 수정할 때 **docs/CALCULATOR_GUIDE.md**를 기준으로 동작이 일치하는지 확인한다. 요약만 아래에 둔다.

## 목표

- 계산기는 브라우저/PC가 꺼져도 **서버에서 계속 동작**하며, 켜서 보면 정확한 계산이 되어 있어야 함.
- 계산기 표·설정은 **calc_sessions(서버)** 에 저장되고, 클라이언트는 복원 시 서버 상태를 따름.

## 서버 스케줄러 (결과 수집·회차 반영)

- **주기**: **1초마다** `_scheduler_fetch_results()` 실행. (클라이언트 접속 여부와 무관, 앱 기동 25초 후 자동 시작.)
- **역할**: 외부 결과 수집 → DB 저장 → `ensure_stored_prediction_for_current_round` → **계산기 회차 반영** `_apply_results_to_calcs` → prediction_history 보정.
- **제1원칙**: 위 흐름은 모두 서버에서만 수행되므로, PC/브라우저를 꺼도 실행 중인 계산기는 회차 누락 없이 계속 반영됨. 간격 변경 시 이 원칙을 유지할 것.

## 계산기 표 (저장·표시)

| 항목 | 규칙 |
|------|------|
| 픽 | 배팅중 픽 + 반픽/승률반픽/연패반픽/승률방향반픽 옵션 적용. 예측기표에는 예측픽만 저장, 계산기 history에는 배팅 픽 저장. |
| 경고승률 | 해당 회차 시점의 **실제 경고 합산승률**(blended)을 history에 `warningWinRate`로 저장·표시. |
| 배팅금액 | 회당 서버에 저장. 멈춤 시 0, 표시는 `-`. |
| 수익 | 매 회 서버에서 계산해 history에 저장. 정지할 때까지 누적. |
| 승패 | **멈춤이어도** 승/패/조커는 항상 기록. `no_bet`/`betAmount=0`만 적용. |

## ⚠ 마틴과 멈춤 — 반드시 구분 (절대 혼동 금지)

- **마틴 적용에 체크만 한 경우**: 멈춤 기능과 **관계가 없다**. 연패 시 해당 마틴 테이블대로 **그냥 계속 진행**하면 된다. 배팅금액은 매 회차 표시.
- **멈춤 옵션에 체크한 경우**: 설정한 승률에 도달하면 **그때부터** 배팅을 멈춘다. 단, **이미 마틴 중**이었다면 마틴을 **끝내고(승을 한 번 하고)** 그다음에 멈춘다.
- **이 두 가지는 별개 사안이다.** 마틴만 켜서 연패 후 승에 따라 자동 멈춤을 걸거나, 멈춤을 “마틴과 같이만 동작”하는 것으로 묶지 말 것. 코드 수정 시 위 두 동작을 혼동하지 않도록 할 것.

## 설정 옵션

- **반픽**: 예측픽 반대로 배팅.
- **승률 반픽**: 실제 경고 합산승률이 설정값 **이하**일 때 반대픽.
- **연패 반픽**: N연패 이상(N 선택 가능, 기본 4)·실제 경고 합산승률이 설정값 **이하**일 때 반대픽. (연패 = 조커·패 포함 연속 손실)
- **승률방향 반픽**: 롤링 50회 승률 기준 저점→고점은 정픽, 고점→저점은 반대픽, 정체 시 직전 방향 참조(상승→정픽, 하락→반대픽).
- **멈춤**: **경고 표 합산승률**이 설정 % **이하**일 때 배팅 멈춤, 배팅금액 `-`. **승패는 반드시 기록**. (마틴과의 관계는 위 “마틴과 멈춤 — 반드시 구분” 섹션 참고.)
- **멈춤 서버 갱신**: `_update_calc_paused_after_round`로 **paused** 갱신. 멈춤 옵션 켜져 있을 때만; 마틴 중(직전이 패/조커)이면 갱신 안 함(마틴 끝난 뒤 멈춤). 완료 회차 0이면 paused 해제.
- **시간**: 설정 시간 종료 시 배팅 정지.
- **목표**: 순익이 목표 도달 시 즉시 정지. 게임 중 변경 가능.

## 버튼

- 실행 / 정지 / 리셋(계산기 표·서버 상태 초기화).

---

상세 내용·구현 위치는 **docs/CALCULATOR_GUIDE.md** 참고. 수정 시 가이드 위반이 없도록 할 것.
