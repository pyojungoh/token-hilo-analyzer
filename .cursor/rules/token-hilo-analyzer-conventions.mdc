---
description: 토큰 하이로우 분석기 회차·결과·히스토리 코딩 규칙 (참고용)
globs: app.py, betting_integration.py, **/macro.py
alwaysApply: true
---

# 토큰 하이로우 분석기 코딩 규칙

이 프로젝트에서 회차(round_num/gameID), 결과 표시, prediction_history 저장을 다룰 때 반드시 지킬 규칙이다. 위반 시 화면에 최신 회차가 안 나오거나 히스토리가 비는 버그가 발생한다.

---

## 1. 회차(round_num / gameID)

- **비교·저장·표시 모두 전체 번호 사용.** 끝 3자리만 쓰면 서로 다른 회차가 같은 숫자로 겹친다(예: 11423052 vs 11424052 → 둘 다 052).
- DB `prediction_history.round_num`, API `round`, 클라이언트 `lastPrediction.round`·`h.round`는 전부 **정수 전체 회차 번호**만 사용한다.
- 화면에 표시할 때도 `displayRound(round)` 등으로 **전체 회차**를 보여 주어 충돌을 방지한다.

---

## 2. API 결과 순서 (맨 앞 = 최신 회차)

- **응답 직전**에 `payload['results']`를 **game_id 기준 내림차순**으로 한 번 더 정렬한다. 캐시/병합 출처와 관계없이 맨 앞이 최신 회차가 되도록 보장한다.
- DB 조회는 **24h(또는 72h 폴백)** 구간을 사용해 타임존·커밋 타이밍 때문에 최신 회차가 빠지지 않게 한다.
- 클라이언트는 서버에서 결과가 1건이라도 오면 **전체 교체**한다. 예전 데이터와 병합해 상위 N개만 쓰는 로직은 사용하지 않는다(과거 데이터가 맨 앞에 고정되는 원인이 됨).
- **맨 왼쪽 카드 = index 0 = 최신 회차.** `displayResults[0]`이 현재 회차이고, DOM/CSS에서 역순으로 그리지 않는다.

---

## 3. prediction_history 저장

- 저장 경로는 두 가지뿐이다: **(1) 클라이언트**가 “현재 회차 = 예측했던 회차”일 때 `/api/save-prediction` 호출, **(2) 서버** 계산기 스케줄러가 `pending_round` 결과 반영 시 `save_prediction_record()` 호출.
- **화면에 최신 회차가 안 나오면** 클라이언트는 “현재 회차”를 인식하지 못해 저장 요청을 안 보낸다. 따라서 **스케줄러에서 최신 회차가 히스토리에 없으면 서버가 자동으로 한 건 보정 저장**하는 로직(`_backfill_latest_round_to_prediction_history`)을 유지한다.
- 보정 시: `results[0]`이 최신 회차, `_get_actual_for_round(results, latest_round)`로 실제 결과, `compute_prediction(results[1:], ph)`로 그 회차에 대한 예측값을 구한 뒤 `save_prediction_record()` 호출.

---

## 4. 정렬·필터 요약

| 위치 | 규칙 |
|------|------|
| DB `get_recent_results` | `ORDER BY (game_id 숫자) DESC`, 시간 구간 24h 등으로 최신 포함 |
| API `get_results()` | 응답 직전 `_sort_results_newest_first(payload['results'])` 강제 적용 |
| 클라이언트 `loadResults` | 서버 결과 수신 시 `allResults = sortResultsNewestFirst(newResults).slice(0, 300)` 전체 교체 |
| 카드 렌더 | `displayResults = allResults.slice(0, 15)`, forEach로 index 0부터 append → 맨 왼쪽이 최신 |

---

## 5. 예측기표 = 메인 예측기 픽 고정 (절대 수정 금지)

- **원칙 (변경 금지)**  
  **예측기표에는 무조건 메인 예측기 픽만 고정값으로 들어가야 한다.**  
  계산기(반픽/승률반픽) 값, 실제 경고 합산승률에 따른 반대픽, 그 밖의 어떤 보정도 예측기표·prediction_history에 넣어서는 안 된다. 이 원칙은 **절대 수정·완화하지 않는다.**
- **명칭 (코드/가이드 통일)**  
  - **메인 예측기**: 상단 왼쪽 박스 — 배팅중 RED/BLACK, 정/꺽 카드, 예측 확률 %, 회차. (`#prediction-pick-container`, `data-section="메인 예측기"`)  
  - **예측기표**: 메인 예측기 바로 아래 — 실제 경고 합산승률, 최근 50회 결과(승/패/조커), 회차별 표(확률·픽·승/패/조커). (`#prediction-box`, `.main-streak-table`, `data-section="예측기표"`)
- **상단** 예측기 밑 **실제 경고 합산승률**, **최근 50회 결과**(승/패/조커), **연승연패**, **스트릭 테이블**은 **무조건 예측픽(prediction_history) 기준**으로만 표시한다. **예측기표 회차별 픽/결과값은 메인 예측기 픽과 동일한 고정 출처만 사용.**
- **계산기(calcState)** 값은 이 영역에 **절대 사용하지 않는다.** 계산기는 반픽/승률반픽 등 배팅 픽을 쓰고, 상단·예측기표는 모델이 예측한 픽 대비 적중만 본다.
- **저장**: `prediction_history` DB 및 `save_prediction_record()`·`savePredictionHistoryToServer`·클라이언트 `predictionHistory.push`에는 **메인 예측기 픽(예측픽)**만 넣는다. 서버 스케줄러에서도 **pred_for_record = pending_predicted(원본)** 로 저장하고, `pred_for_calc`(반픽/승률반픽 적용)는 **계산기 history에만** 쓴다.
- **기록 시 출처**: prediction_history/예측기표에 넣을 픽은 **반드시** `getRoundPrediction(round)` 또는 `lastPrediction`(서버에서 온 값)에서만 취한다. `predictionHistory.find(round)`는 배팅픽 오염 가능이 있으므로 **기록용으로 사용하지 않는다.**
- 이 기준이 흔들리면 합산승률이 50% 이하일 때 예측기표에 반대값이 들어가는 등 버그가 재발한다. **규칙/가이드에서 “예측기표 = 메인 예측기 픽 고정”을 삭제하거나 완화하지 말 것.**

---

이 규칙을 수정·확장할 때는 “맨 왼쪽 = 최신 회차”, “히스토리 누락 없이 서버 보정”, “예측기표 = 메인 예측기 픽 고정(절대 수정 금지)”, “상단 합산승률·결과 = 예측픽 전용”을 유지한다.
