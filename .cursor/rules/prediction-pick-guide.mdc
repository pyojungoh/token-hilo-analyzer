---
description: 예측픽 작동 원리·수정 시 준수 원칙 (AI가 항상 인지할 것)
globs: app.py, docs/PREDICTION_*.md, docs/CSV_*.md, docs/CALCULATOR_*.md
alwaysApply: true
---

# 예측픽 작동 원리 및 수정 가이드

예측픽(compute_prediction) 관련 코드를 다룰 때 **항상** 이 문서의 원칙을 인지하고 따른다. 어떤 상황에서 수정하더라도 아래 핵심을 유지한다.

---

## 1. 핵심 원칙 (절대 유지)

### 1.1 정과 꺽은 하나의 픽

- **정과 꺽은 서로 경쟁하는 전략이 아니다.**
- "정이 유리" vs "꺽이 유리" 표현 **금지**. **"이 밸런스·모양일 때 다음 결과가 정일 확률 vs 꺽일 확률"**을 따진다.
- CSV·분석 결과 서술 시: "정이 더 많이 나왔다" / "꺽이 더 많이 나왔다" (분포)만 사용. "유리", "권장" 사용 금지.
- 예측기는 **유지(줄)** vs **바뀜(퐁당)** 방향을 먼저 결정하고, 직전 결과(last)에 따라 정/꺽으로 변환한다.

### 1.2 모양을 중시한다

- 이 게임은 **밸런스(균형)**와 **모양(패턴)**을 많이 만든다.
- **밸런스**: 같은 것(정정/꺽꺽) vs 바뀌는 것(정꺽/꺽정)의 비율. 퐁당%/줄%, 전환점(덩어리↔퐁당).
- **모양**: 덩어리모양(321, 123, block_repeat), 줄run/퐁당run, 세그먼트(J/K 시퀀스).
- **조건(밸런스 + 모양) → 다음 실제 결과(정/꺽) 분포**를 기준으로 픽을 결정한다.

### 1.3 예측기표 = 메인 예측기 픽 고정

- 예측기표·prediction_history에는 **메인 예측기 픽만** 저장한다.
- 계산기(반픽/승률반픽) 값, 실제 경고 합산승률에 따른 반대픽은 **예측기표에 넣지 않는다.**
- 연패 반영은 **스마트반픽(계산기)**에서만. 예측픽 자체는 연패를 보지 않는다.

---

## 2. 예측픽이 어떻게 작동하는가

### 2.1 전체 흐름

```
[입력] results → graph_values (정/꺽 시퀀스)
    ↓
line_pct, pong_pct (최근 15회) → 밸런스
    ↓
phase (줄/덩어리/퐁당/전환) → 구간 판별
    ↓
line_w (올리는 방향) vs pong_w (직진 방향) → 가산 누적
    ↓
정규화 → adj_same vs adj_change
    ↓
last 반영 → predict = 정 또는 꺽
```

### 2.2 방향의 의미

| 방향 | line_w | pong_w | 의미 |
|------|--------|--------|------|
| **올리는** | ↑ | ↓ | 같은 픽 유지 (줄·덩어리) |
| **직진** | ↓ | ↑ | 번갈아 픽 (퐁당) |

- **덩어리·줄 많음** → 올리는 방향(line_w) 가산
- **퐁당 많음** → 직진 방향(pong_w) 가산

### 2.3 정/꺽 변환

- `adj_same >= adj_change` → **유지** (last 그대로)
- `adj_same < adj_change` → **바뀜** (last 반대)
- `predict = ('정' if last else '꺽')` 또는 `('꺽' if last else '정')` — last(직전 결과)에 따라 정/꺽으로 변환

### 2.4 가산 요소 (요약)

| 요소 | 올리는(line_w) | 직진(pong_w) |
|------|----------------|--------------|
| phase | line_phase, chunk_*, pong_to_chunk | pong_phase, chunk_to_pong |
| symmetry | avg_mean_line(줄만 평균) 높음, 좌우 유사 | - |
| 퐁당 간격 | avg_pong_gap ≤1.5 | avg_pong_gap ≥3 |
| 장줄/장퐁당 | line_runs[0]≥5 | pong 2~6→pong_w(유지), pong 7+→line_w(끊김 예상) |
| shape_win_stats | 해당 모양에서 정 많음 + last=정 | 해당 모양에서 꺽 많음 + last=꺽 |

---

## 3. 덩어리 vs 퐁당 (용어·구분)

### 3.1 용어 정의 (절대 준수)

| 용어 | 정의 | 예시 | 코드 조건 |
|------|------|------|-----------|
| **퐁당** | **정꺽정꺽** — 1개씩만 교대 | 정꺽정꺽정꺽 | `line_runs` 비어 있음 |
| **덩어리** | **정정꺽꺽정정꺽꺽** — 2개 이상 묶음 반복 | 정정꺽꺽, 정정정정꺽꺽꺽꺽 | `line_runs` 존재 |

- **정정꺽꺽정정꺽꺽** → 덩어리 (퐁당 아님)
- **정꺽정꺽** → 퐁당 (덩어리 아님)
- `pong_phase` 반환: line_runs가 비어 있을 때만. line_runs가 있으면 chunk_phase.

### 3.2 줄·퐁당 전환 주의

- **2줄만 되면 줄을 줄라고 함**: 줄 1~4일 때 chunk_phase/chunk_start → line_w 가산.
- **줄에서 내려오면 바로 퐁당으로 가지 않음**: 주변 모양이 일관되면 chunk_to_pong 대신 chunk_phase 유지.

---

## 4. 주변 모양 일관성 (패턴 유지 확률)

### 4.1 원칙

- **주변 = 메인픽 그래프 최소 30열** 기준.
- **줄 높이 정밀 분석**: 단순 "2개 이상"이 아니라 **3개가 계속 이어짐**, **2개3개가 이어짐** — 시퀀스 단위로 분석.
- **덩어리 사이 퐁당 간격**: **퐁당 3번 이뤄지고 다음번도 3번** — 퐁당 길이 시퀀스도 분석.

### 4.2 분석 대상

| 대상 | 예시 | 의미 |
|------|------|------|
| **줄 높이 시퀀스** | [3,3,3,3] 3개가 계속 이어짐 | line_runs 일관성 |
| **줄 높이 시퀀스** | [2,3,2,3] 2개3개가 이어짐 | 반복 패턴 |
| **퐁당 간격 시퀀스** | [3,3,3] 퐁당 3번→다음도 3번 | pong_runs 일관성 |

### 4.3 패턴별 가중치

| 주변 패턴 | 예시 | 가중치 |
|-----------|------|--------|
| **정정꺽꺽 반복** (chunk_11) | 2개씩 묶음 일관 | line_w ↑ |
| **줄퐁당줄퐁당** (line_pong_21/31) | 정정꺽정정꺽정정꺽 | pong_w ↑ |
| **줄N퐁당M** (line3_pong3 등) | 줄 3·퐁당 3 반복 | pong_w ↑ |

### 4.4 적용 규칙

- 줄 높이·퐁당 간격 시퀀스 각각 일관성 계산 후 pair_consistency와 결합.
- consistency ≥ 0.6이면 패턴 유지 가중치 적용. 최대 12쌍 분석.
- **chunk_to_pong 전환**: 주변 패턴 일관되면 chunk_phase 유지.

---

## 5. 수정 시 반드시 지킬 것

### 5.1 원칙 준수

- **정/꺽 경쟁 프레임 금지**: "정이 이기면", "꺽을 올리면" 같은 표현·로직 사용 금지. "이 조건일 때 다음이 정/꺽 중 어느 쪽이 더 나왔는가"로 판단.
- **모양 우선**: 밸런스·phase·chunk_shape·줄run/퐁당run을 먼저 보고, 그에 맞게 line_w/pong_w만 조정.
- **예측기표 오염 금지**: prediction_history·예측기표에는 메인 예측기 픽만. 반픽·승률반픽은 계산기 history에만.
- **퐁당/덩어리 구분 유지**: "퐁당" = 정꺽정꺽만. 정정꺽꺽은 덩어리.

### 5.2 가산 조정 시

- **포인트값만 수정**: 민감도 조정은 상수(DELTA, RATIO, 가산량)만 변경. 로직 분기 추가·삭제는 신중히.
- **서버·클라이언트·패널 동기화**: line_w/pong_w 관련 상수는 세 곳 모두 동일하게.
- **과도한 가산 금지**: ±0.04~0.08 범위에서 소폭 조정. 한 번에 한 구간만 수정 후 검증.
- **주변 모양 30열**: 패턴 일관성 분석은 메인픽 그래프 최소 30열 기준.

### 5.3 주석·의도 명시

- `# [올리는 방향]` / `# [직진 방향]` 주석으로 의도 명확히.
- 수정 시 "왜 이 방향인가"를 주석에 남긴다.

---

## 6. 참고 문서

| 문서 | 용도 |
|------|------|
| `.cursor/rules/chunk-pong-terminology.mdc` | 덩어리 vs 퐁당 용어 (상세) |
| `docs/PREDICTION_STRUCTURE_REFACTOR.md` | 구조·phase·퐁당 간격·장퐁당 규칙 |
| `docs/CSV_BETTING_ADVICE_GUIDE.md` | CSV 분석·모양→가중치 변환·수정 절차 |
| `docs/PREDICTION_AND_RESULT_SPEC.md` | 정/꺽→빨강/검정, graph_values, 승패 규격 |
| `.cursor/rules/token-hilo-analyzer-conventions.mdc` | 예측기표=메인 픽 고정, 회차·결과 규칙 |

---

## 7. 한 줄 요약

**정/꺽은 하나의 픽이고, 모양을 중시해서 밸런스·phase·주변 일관성(30열)에 따라 line_w(유지) vs pong_w(바뀜)를 조정한 뒤, last에 따라 정/꺽으로 변환한다. 덩어리=정정꺽꺽 등 블록, 퐁당=정꺽정꺽만. 수정 시 이 원칙을 유지한다.**
