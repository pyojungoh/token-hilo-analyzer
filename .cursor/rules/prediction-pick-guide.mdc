---
description: 예측픽 작동 원리·수정 시 준수 원칙 (AI가 항상 인지할 것)
globs: app.py, docs/PREDICTION_*.md, docs/CSV_*.md, docs/CALCULATOR_*.md
alwaysApply: true
---

# 예측픽 작동 원리 및 수정 가이드

예측픽(compute_prediction) 관련 코드를 다룰 때 **항상** 이 문서의 원칙을 인지하고 따른다. 어떤 상황에서 수정하더라도 아래 핵심을 유지한다.

---

## 1. 핵심 원칙 (절대 유지)

### 1.1 정과 꺽은 하나의 픽

- **정과 꺽은 서로 경쟁하는 전략이 아니다.**
- "정이 유리" vs "꺽이 유리"가 아니라, **"이 밸런스·모양일 때 다음 결과가 정일 확률 vs 꺽일 확률"**을 따진다.
- 예측기는 **유지(줄)** vs **바뀜(퐁당)** 방향을 먼저 결정하고, 직전 결과(last)에 따라 정/꺽으로 변환한다.

### 1.2 모양을 중시한다

- 이 게임은 **밸런스(균형)**와 **모양(패턴)**을 많이 만든다.
- **밸런스**: 같은 것(정정/꺽꺽) vs 바뀌는 것(정꺽/꺽정)의 비율. 퐁당%/줄%, 전환점(덩어리↔퐁당).
- **모양**: 덩어리모양(321, 123, block_repeat), 줄run/퐁당run, 세그먼트(J/K 시퀀스).
- **조건(밸런스 + 모양) → 다음 실제 결과(정/꺽) 분포**를 기준으로 픽을 결정한다.

### 1.3 예측기표 = 메인 예측기 픽 고정

- 예측기표·prediction_history에는 **메인 예측기 픽만** 저장한다.
- 계산기(반픽/승률반픽) 값, 실제 경고 합산승률에 따른 반대픽은 **예측기표에 넣지 않는다.**
- 연패 반영은 **스마트반픽(계산기)**에서만. 예측픽 자체는 연패를 보지 않는다.

---

## 2. 예측픽이 어떻게 작동하는가

### 2.1 전체 흐름

```
[입력] results → graph_values (정/꺽 시퀀스)
    ↓
line_pct, pong_pct (최근 15회) → 밸런스
    ↓
phase (줄/덩어리/퐁당/전환) → 구간 판별
    ↓
line_w (올리는 방향) vs pong_w (직진 방향) → 가산 누적
    ↓
정규화 → adj_same vs adj_change
    ↓
last 반영 → predict = 정 또는 꺽
```

### 2.2 방향의 의미

| 방향 | line_w | pong_w | 의미 |
|------|--------|--------|------|
| **올리는** | ↑ | ↓ | 같은 픽 유지 (줄·덩어리) |
| **직진** | ↓ | ↑ | 번갈아 픽 (퐁당) |

- **덩어리·줄 많음** → 올리는 방향(line_w) 가산
- **퐁당 많음** → 직진 방향(pong_w) 가산

### 2.3 정/꺽 변환

- `adj_same >= adj_change` → **유지** (last 그대로)
- `adj_same < adj_change` → **바뀜** (last 반대)
- `predict = ('정' if last else '꺽')` 또는 `('꺽' if last else '정')` — last(직전 결과)에 따라 정/꺽으로 변환

### 2.4 가산 요소 (요약)

| 요소 | 올리는(line_w) | 직진(pong_w) |
|------|----------------|--------------|
| phase | line_phase, chunk_*, pong_to_chunk | pong_phase, chunk_to_pong |
| symmetry | avg_mean 높음, 좌우 유사 | - |
| 퐁당 간격 | avg_pong_gap ≤1.5 | avg_pong_gap ≥3 |
| 장줄/장퐁당 | line_runs[0]≥5 | pong_runs[0]≥5 → line_w (끊김 예상) |
| shape_win_stats | 해당 모양에서 정 많음 + last=정 | 해당 모양에서 꺽 많음 + last=꺽 |

---

## 3. 수정 시 반드시 지킬 것

### 3.1 원칙 준수

- **정/꺽 경쟁 프레임 금지**: "정이 이기면", "꺽을 올리면" 같은 표현·로직 사용 금지. "이 조건일 때 다음이 정/꺽 중 어느 쪽이 더 나왔는가"로 판단.
- **모양 우선**: 밸런스·phase·chunk_shape·줄run/퐁당run을 먼저 보고, 그에 맞게 line_w/pong_w만 조정.
- **예측기표 오염 금지**: prediction_history·예측기표에는 메인 예측기 픽만. 반픽·승률반픽은 계산기 history에만.

### 3.2 가산 조정 시

- **포인트값만 수정**: 민감도 조정은 상수(DELTA, RATIO, 가산량)만 변경. 로직 분기 추가·삭제는 신중히.
- **서버·클라이언트·패널 동기화**: line_w/pong_w 관련 상수는 세 곳 모두 동일하게.
- **과도한 가산 금지**: ±0.04~0.08 범위에서 소폭 조정. 한 번에 한 구간만 수정 후 검증.

### 3.3 주석·의도 명시

- `# [올리는 방향]` / `# [직진 방향]` 주석으로 의도 명확히.
- 수정 시 "왜 이 방향인가"를 주석에 남긴다.

---

## 4. 참고 문서

| 문서 | 용도 |
|------|------|
| `docs/PREDICTION_STRUCTURE_REFACTOR.md` | 구조·phase·퐁당 간격·장퐁당 규칙 |
| `docs/CSV_BETTING_ADVICE_GUIDE.md` | CSV 분석·모양→가중치 변환·수정 절차 |
| `docs/PREDICTION_AND_RESULT_SPEC.md` | 정/꺽→빨강/검정, graph_values, 승패 규격 |
| `.cursor/rules/token-hilo-analyzer-conventions.mdc` | 예측기표=메인 픽 고정, 회차·결과 규칙 |

---

## 5. 한 줄 요약

**정/꺽은 하나의 픽이고, 모양을 중시해서 밸런스·phase에 따라 line_w(유지) vs pong_w(바뀜)를 조정한 뒤, last에 따라 정/꺽으로 변환한다. 수정 시 이 원칙을 유지한다.**
