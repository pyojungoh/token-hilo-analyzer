# 계산기 가이드

이 문서는 토큰하이로우 분석기의 **가상 배팅 계산기** 동작 기준입니다. 계산기 관련 코드 수정 시 반드시 이 가이드와 일치하도록 구현합니다.

---

## 목표

계산기는 **컴퓨터가 꺼지거나 브라우저가 꺼져도 서버에서 항상 돌아가서**, 언제든 켜서 봤을 때 정확한 계산이 되어 있어야 한다.

- 서버: `calc_sessions` 테이블에 계산기 상태(history 포함) 저장, 스케줄러가 **1초마다** 회차 반영·저장.
- 클라이언트: 새로고침/재접속 시 서버 상태를 불러와 계산기표·설정을 복원.

---

## 계산기 표

계산기 표 데이터는 **서버의 계산기 상태(calc_sessions)** 안에 저장되며, 각 회차별로 아래 항목이 기록된다.

| 열 | 설명 | 구현 요건 |
|----|------|-----------|
| **픽** | 배팅중 픽이 들어가야 함. **승률 반픽**·**연패 반픽**·**승률방향 반픽** 체크 시 설정한 조건에서 반대픽으로 배팅. | 예측픽(배팅중 픽) + 반픽/승률반픽/연패반픽/승률방향반픽 옵션 적용한 값으로 표시·저장. |
| **경고승률** | 메인에 있는 **실제 경고 합산승률**(15·30·100 가중)을 해당 회차마다 서버에 저장해 표에 나타냄. | `warningWinRate` = blended(예측기표 기준 합산승률). |
| **배팅금액** | 회당 배팅금액을 서버에 정확히 저장하고 표시. **멈춤 상태**에서는 `-` 표시. | `betAmount` 저장, `no_bet`이면 0이며 표시는 `-`. |
| **수익** | 수익은 매 회 서버에 저장되어 정확히 계산되며, 계산기가 정지할 때까지 결과값과 수익이 계속 저장·계산됨. | 서버 `_calculate_calc_profit_server`로 회차별 수익 계산 후 history에 저장. |
| **승패** | 해당 회차의 실제 결과와 픽을 대조해 맞는지/틀리는지 기록. **멈춤이 체크되어 있어도** 배팅금액은 안 나오지만 **승패는 반드시 항상 서버에 저장되고 표에 나타나야 함.** | `paused`여도 `predicted`/`actual`로 승/패/조커 기록, `no_bet`/`betAmount=0`만 적용. |

---

## 설정 옵션

### 픽 / 승률

- **반픽**: 예측픽의 반대로 배팅한다.
- **승률 반픽**: 실제 경고 합산승률이 설정한 값 **이하**로 떨어지면 예측픽의 반대로 배팅한다.
- **연패 반픽**: **N연패 이상**(N은 2~15에서 선택, 기본 4)일 때, 실제 경고 합산승률이 설정한 값 **이하**이면 예측픽의 반대로 배팅한다. (연패 = 조커·패 포함 끝에서부터 연속 손실)
- **승률방향 반픽**: 예측기표(롤링 50회 승률) 기준으로 **저점→고점**(저점 상승 구간)이면 **정픽**, **고점→저점**(고점 하락 구간)이면 **반대픽**, **정체 구간**이면 **직전 방향**을 참고해 직전이 상승이었으면 정픽, 직전이 하락이었으면 반대픽으로 배팅한다.

### 멈춤

- **기준: 계산기 표의 15회 승률**(해당 계산기가 실제로 배팅한 최근 15회 승률). 표 하단 "15회승률"과 **동일한 수치**로 판단한다. 설정한 **% 이하**로 떨어지면 배팅을 멈춘다. (예: 45% 설정이면 표 15회승률이 45% 이하일 때 멈춤.)
- 이때 계산기 배팅금액은 들어가지 않는다 (`-` 표시).
- **이력(히스테리시스)**: 멈춤 해제는 **기준+3% 초과**일 때만 한다(예: 50% 이하→멈춤, **53% 초과**→재개). 기준 근처에서 전환 빈도를 줄인다.
- 이때 **반드시 승패는 기록**되어야 한다.
- **마틴만 체크**한 경우: 멈춤과 관계없이 연패 시 해당 마틴 테이블대로 계속 진행한다. (멈춤 기능과 별개.)
- **멈춤 옵션을 체크**한 경우: 계산기 표 15회 승률이 설정값 이하이면 그때부터 배팅을 멈춘다. 단, **이미 마틴 중**(연패 구간)이면 마틴을 끝낸 뒤(승을 한 번 하고) 그다음 회차부터 멈춤한다. (마틴과 멈춤은 별개 사안.)

### 시간

- 시간을 정해 두면 정해진 시간 동안만 배팅을 진행하고, 시간이 끝나면 배팅이 정지된다.

### 마틴

- 마틴 적용에 체크하면 드롭다운 메뉴에 있는 마틴 방식(표마틴 / 표마틴 반)을 사용하여 패할 때마다 배팅금액을 마틴한다.

### 목표

- 체크 시 **순익**이 목표에 도달하면 즉시 배팅을 정지한다.
- 목표 체크는 게임 중 아무 때나 실시 가능하다.

---

## 버튼

- **실행**: 계산기를 실행한다.
- **정지**: 계산기의 배팅이 멈춘다.
- **리셋**: 계산기 표의 모든 데이터를 삭제하고 처음 상태로 돌아간다. (서버 상태도 초기화)

---

## 구현 참고 (코드 위치)

- 결과 수집 스케줄러: **1초마다** `_scheduler_fetch_results()` (앱 기동 25초 후 자동 시작, 클라이언트 무관).
- 서버 회차 반영: `_apply_results_to_calcs`, `ensure_stored_prediction_for_current_round`
- 계산기 상태 저장/조회: `save_calc_state`, `get_calc_state`, `calc_sessions`
- 수익·마틴 계산: `_calculate_calc_profit_server`
- **멈춤 (서버)**: 회차 반영 후 `_update_calc_paused_after_round`로 **paused** 갱신. 멈춤 옵션 켜져 있을 때만 적용하며, 마틴 중(직전 완료가 패/조커)이면 마틴 끝날 때까지 paused 갱신 안 함. 클라이언트 꺼져 있어도 멈춤 정확 동작.
- 클라이언트 멈춤: `checkPauseAfterWin`(멈춤 옵션 켜져 있을 때만; 마틴 중이면 연패 끝난 뒤(승 한 번 나온 뒤) 멈춤), `effectivePausedForRound`(마틴 중 연패 구간이면 배팅 계속)
- 계산기 표 렌더: `updateCalcDetail`, `calcState[id].history`

수정 시 이 가이드와 규칙 파일(`.cursor/rules/calculator-guide.mdc`)을 함께 확인할 것.
