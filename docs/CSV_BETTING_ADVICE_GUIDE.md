# CSV 배팅 어드바이스 가이드

이 문서는 **graph_analysis CSV**를 받았을 때 AI가 배팅 어드바이스를 제공하는 방법을 정의한다.  
CSV 파일만 주어져도 밸런스·모양 분석을 통해 픽 권장과 임계값 수정 제안을 할 수 있도록 한다.

---

## 1. 기본 원칙

### 1.1 정과 꺽은 같은 픽

- 정과 꺽은 서로 경쟁하는 전략이 아니다.
- **"이 밸런스·모양일 때 다음 결과가 정일 확률 vs 꺽일 확률"**을 따져야 한다.
- 이 게임은 **밸런스(균형)**와 **모양(패턴)**을 많이 만든다.

### 1.2 밸런스와 모양

| 개념 | 설명 |
|------|------|
| **밸런스** | 같은 것(정정/꺽꺽) vs 바뀌는 것(정꺽/꺽정)의 비율. 퐁당%/줄%, 전환점(덩어리↔퐁당) |
| **모양** | 덩어리모양(321, 123, block_repeat), 줄run/퐁당run, 세그먼트(J/K 시퀀스) |

---

## 2. CSV 컬럼 구조

| 컬럼 | 의미 |
|------|------|
| 회차 | round_num |
| 픽 | 예측했던 픽 (정/꺽) |
| 실제 | 실제 결과 (정/꺽/joker) |
| 승패 | 승/패/조 |
| 경고승률 | blended_win_rate (예측기표 15·30·100 가중 승률) |
| 줄개수, 퐁당개수 | 줄 run 개수, 퐁당 run 개수 |
| 구간 | line_phase, pong_phase, chunk_*, chunk_to_pong, pong_to_chunk 등 |
| 덩어리유형 | 띄엄띄엄, 높은덩어리 등 |
| 덩어리모양 | 321, 123, block_repeat, chunk_to_pong, - |
| 줄run, 퐁당run | 연속 길이 시퀀스 (최신→과거) |
| 줄%, 퐁당% | 최근 15회 기준 |
| 높이 | 막대 그래프 높이 (1=퐁당, 2+=줄) |
| 세그먼트 | J1,K2,J3... (J=정, K=꺽 + 연속 개수) |

---

## 3. 분석 절차

### Step 1: 막대 그래프로 모양 파악

- **높이** 열로 막대 그래프를 그릴 수 있다.
- 자주 나오는 모양을 찾는다:
  - 덩어리 → 긴줄 → 덩어리
  - 줄 → 퐁당 1개 → 줄
  - 줄1퐁당1 반복
  - 긴줄 직후 끊김
  - 기타 반복 패턴

### Step 2: 모양별 다음 결과 집계

- 각 모양이 나왔을 때 **그 다음 회차 실제 결과(정/꺽)**를 집계.
- "이 밸런스 + 이 모양일 때 다음이 정 몇 %, 꺽 몇 %" 계산.

### Step 3: 자주 나오는 모양 우선

- 등장 빈도가 높은 모양부터 정리.
- 정/꺽 비율이 뚜렷한(55% 이상) 모양을 우선 반영.

### Step 4: 조건부 확률 기반 픽 권장

- **조건(밸런스 + 모양) → 다음 실제 결과(정/꺽) 분포**를 기준으로 픽 권장.
- "정이 유리" vs "꺽이 유리"가 아니라, "이 조건일 때 다음은 정/꺽 중 어느 쪽이 더 나왔는가"로 판단.

---

## 4. 배팅 어드바이스 제공

### 4.1 픽 권장

- 현재 그래프 상태(최근 행)를 어떤 모양에 매칭.
- 그 모양에서 다음 결과가 정/꺽 중 어느 쪽이 더 나왔는지 제시.
- **예시**: "덩어리→퐁당 + 퐁당≥58% 패턴이 최근에 많음. 이 모양일 때 다음 꺽 52%. 꺽 쪽 픽 권장."

### 4.2 임계값 수정 제안

- **경고승률** 구간별로 정픽승률·반픽승률 계산.
- 구간: ≤43%, 43~50%, 50~57%, ≥57%
- 반픽이 유리한 구간의 상한을 스마트반픽 임계값 권장으로 제시.
- **예시**: "≤43%에서만 반픽 승률 > 정픽 승률. 43~50%에서는 정픽 유리. → 스마트반픽 임계값 43% 권장."

### 4.3 모양 기반 공식 제안

- 자주 나오는 모양 + 그 다음 결과 비율을 정리.
- app.py 예측 공식에 반영할 가중치 방향 제안 (line_w/pong_w).
- **코딩하지 말고** "이 모양일 때 line_w +0.08, pong_w -0.04 권장" 형태로 제시.

---

## 5. CSV 상단 프롬프트 (app.py용)

CSV 다운로드 시 상단에 포함될 분석 지시. 아래 내용으로 `GRAPH_ANALYSIS_CSV_PROMPT`를 교체한다.

```
# CSV 배팅 어드바이스 지시:
# 1. 이 CSV는 막대 그래프(높이·세그먼트·줄run·퐁당run) 데이터를 담고 있다.
# 2. 밸런스(퐁당%/줄%, 구간 전환)와 모양(덩어리모양, run 패턴)을 분석한다.
# 3. 자주 나오는 모양을 찾고, 각 모양일 때 다음 회차 실제 결과(정/꺽) 비율을 집계한다.
# 4. 정 vs 꺽 "어느 쪽이 유리한가"가 아니라, "이 조건일 때 다음이 정/꺽 중 어느 쪽이 더 나왔는가"로 판단한다.
# 5. 배팅 어드바이스: 현재 상태에 맞는 모양을 매칭해 픽(정/꺽) 권장을 제시한다.
# 6. 임계값: 경고승률 구간별(≤43%, 43~50%, 50~57%, ≥57%) 정픽승률·반픽승률을 계산하고, 스마트반픽 임계값 권장을 제시한다.
# 7. 필요 시 app.py 예측 공식 반영 방향(모양별 line_w/pong_w)을 제안한다. 코딩은 하지 않는다.
```

---

## 6. 새 채팅에서 사용 방법

1. **CSV 파일**을 첨부한다. (export-graph-analysis로 다운로드한 파일)
2. **이 문서**를 `@docs/CSV_BETTING_ADVICE_GUIDE.md`로 참조한다.
3. AI는 CSV 상단 프롬프트 + 이 가이드를 따라:
   - 밸런스·모양 분석
   - 픽 권장
   - 임계값 수정 제안
   - 공식 반영 방향 제안
   을 제공한다.
4. **예측픽이 엉망일 때** → **§8 예측픽 수정 절차**를 따라 app.py `compute_prediction`을 직접 수정한다.

---

## 7. 모양 → 가중치 변환 참고

| 모양 다음 결과 | line_w | pong_w |
|----------------|--------|--------|
| 정 60%, 꺽 40% | +0.15 | -0.08 |
| 정 55%, 꺽 45% | +0.08 | -0.04 |
| 정 50%, 꺽 50% | 0 | 0 |
| 정 45%, 꺽 55% | -0.04 | +0.08 |
| 정 40%, 꺽 60% | -0.08 | +0.15 |

---

## 8. 예측픽 수정 절차 (CSV 분석 → app.py 반영)

예측픽이 엉망일 때, CSV 분석 결과를 바탕으로 **app.py 예측 공식**을 수정하는 절차다.

### 8.1 전체 흐름

```
CSV 분석(모양별 다음 정/꺽 비율) → 비율→가중치 변환(표 7) → app.py compute_prediction 내 해당 phase/chunk_shape 분기 수정
```

### 8.2 CSV 컬럼 ↔ app.py 매핑

| CSV 컬럼 | app.py 변수 | 위치 |
|----------|-------------|------|
| 구간 | `phase` | `_detect_pong_chunk_phase()` 반환값 |
| 덩어리모양 | `chunk_shape` | `pong_chunk_debug['chunk_shape']` |
| 줄%, 퐁당% | `pong_pct`, `line_pct` | `_pong_line_pct(graph_values[:15])` |

**phase 값 대응**

| CSV 구간 | app.py phase |
|----------|--------------|
| 덩어리→퐁당 | `chunk_to_pong` |
| 퐁당→덩어리 | `pong_to_chunk` |
| 덩어리시작, 덩어리구간 | `chunk_start`, `chunk_phase` |
| 퐁당구간 | `pong_phase` |
| 줄구간 | `line_phase` |
| - (미분류) | `None` |

**chunk_shape 값 대응**

| CSV 덩어리모양 | app.py chunk_shape |
|----------------|---------------------|
| 321 | `'321'` |
| 123 | `'123'` |
| block_repeat | `'block_repeat'` |
| chunk_to_pong | `'chunk_to_pong'` (phase가 chunk_to_pong일 때) |
| - | `None` 또는 `'-'` |

### 8.3 app.py 수정 위치

`compute_prediction` 함수 내 **phase·chunk_shape 분기** (약 3997~4110행):

| 분기 | 현재 동작 | 수정 시 |
|------|-----------|---------|
| `phase == 'line_phase'` | line_w += 0.12, pong_w -= 0.06 | 줄 구간: 정 과다면 line_w 감소, 꺽 과다면 pong_w 증가 |
| `phase in ('chunk_start','chunk_phase','pong_to_chunk')` | chunk_shape별 line_w/pong_w 가감 | 덩어리 구간: CSV 비율에 맞게 조정 |
| `phase == 'chunk_to_pong'` | pong_w += 0.15, line_w = 1-pong_w | 덩어리→퐁당: 꺽 과다면 pong_w 유지/강화, 정 과다면 감소 |
| `phase == 'pong_phase'` | pong_w += 0.14 | 퐁당 구간: CSV 비율에 맞게 조정 |
| `phase is None` | pong_pct≥55 / ≤42 분기 | 미분류: pong_pct 기준 가중치 조정 |

### 8.4 수정 절차 (단계별)

1. **CSV에서 모양별 다음 결과(정/꺽) 비율 집계**
   - `analyze_csv_betting_advice.py` 또는 수동 집계
   - 예: `chunk_to_pong` → 정 46.7%, 꺽 53.3%

2. **표 7로 가중치 방향 결정**
   - 정 46.7%, 꺽 53.3% → 꺽 쪽 유리 → pong_w 증가, line_w 감소
   - 참고: 정 45%/꺽 55% → pong_w +0.08, line_w -0.04

3. **app.py에서 해당 분기 찾기**
   - `phase == 'chunk_to_pong'` → 4081행 근처
   - `chunk_shape == '321'` → 4034~4041행 근처

4. **숫자 조정**
   - 현재: `pong_w += 0.15` (chunk_to_pong)
   - CSV에서 꺽 53.3% → 꺽 쪽 소폭 유리 → 0.15 유지 또는 0.12~0.18 범위에서 미세 조정
   - CSV에서 정 55% 이상이면 → pong_w 감소(예: 0.10), line_w 증가

5. **클라이언트 동기화**
   - `compute_prediction`은 서버·클라이언트 공통. JS에 `computePrediction`이 있으면 동일 로직 반영 필요.

### 8.5 수정 예시

**예: 덩어리→퐁당(chunk_to_pong)에서 정 과다(55%)로 나옴**

- CSV: chunk_to_pong → 정 55%, 꺽 45%
- 해석: 현재 pong_w가 너무 커서 꺽을 과대 예측함
- 수정: `pong_w += 0.15` → `pong_w += 0.08` 또는 `0.10`으로 감소

**예: 덩어리 321에서 꺽 과다(55%)로 나옴**

- CSV: 321 → 정 45%, 꺽 55%
- app.py: `chunk_shape == '321'` 분기 (4034~4041행)
- 수정: `pong_w += 0.05` → `pong_w += 0.08` (꺽 가산 강화) 또는 `line_w -= 0.025` → `line_w -= 0.04`

### 8.6 주의사항

- **한 번에 한 구간만** 수정하고, 수정 후 CSV 재분석 또는 실제 승률 확인.
- **과도한 가중치**는 다른 구간에서 역효과. ±0.04~0.08 범위에서 소폭 조정 권장.
- `.cursor/rules/win-rate-direction.mdc` — 승률방향(정픽/반픽)은 별도. 예측픽 자체 수정과 혼동하지 말 것.

---

*이 문서는 CSV 기반 배팅 어드바이스 워크플로우를 정의한다. 수정 시 "밸런스·모양 기반", "정/꺽 동등", "조건부 확률" 원칙을 유지한다.*
