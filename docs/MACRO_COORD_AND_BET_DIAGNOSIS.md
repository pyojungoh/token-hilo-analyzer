# 매크로 좌표·배팅·금액 오류 진단

## 1. 좌표 지맘대로 누를 때 (이거저거 다 누르는 현상)

### 원인 추정
- **탭 간 대기 시간 부족**: UI 반영 전에 다음 탭 실행
- **스와이프 지속시간**: 100ms 터치가 일부 기기에서 드래그로 인식되거나, 짧아서 미등록될 수 있음

### 적용 수정
- `D_AFTER_AMOUNT_TAP`: 0.08초 (금액 칸 탭 후)
- `D_AFTER_INPUT`: 0.04초 (금액 입력 후 레드/블랙 탭 전)
- `D_AFTER_COLOR`: 0.05초 (레드/블랙 탭 후)
- `_do_bet_lock`: 배팅 실행 중 중복 호출 방지
- **BACK 키 사용 안 함** — 금액 넣고 바로 레드/블랙 탭 (키보드 닫기 없음)

---

## 2. 승 후 2번행에도 배팅 (1번행+2번행 동시 배팅)

### 원인 추정
- **레이아웃 변화**: 승 후 테이블 스크롤/갱신 시 고정 좌표가 다른 행을 가리킬 수 있음
- **연속 호출**: `_try_bet_if_needed`가 짧은 간격으로 두 번 호출되면, 첫 배팅 직후 두 번째 호출이 같은 회차로 또 배팅할 수 있음 (lock 없음)
- **배팅 직후 쿨다운 없음**: 배팅 완료 후 최소 1.5초 대기 없이 다음 폴링에서 즉시 재진입 가능

### 적용 수정
- `_do_bet_lock`: 배팅 실행 시 락으로 한 번에 하나만 실행
- `_last_bet_at`: 배팅 완료 시각 기록, 최소 1.2초 경과 전에는 같은 회차 재배팅 스킵

---

## 3. 매크로 계산기표 금액값이 바뀌는 문제 (데이터 많아질 때)

### 원인 추정
- **회차 중복**: history에 동일 회차가 두 번 들어가면 마틴 시뮬레이션이 잘못됨
- **round_actuals 병합 순서**: API에서 오는 결과 순서가 꼬이면 completed 정렬이 일시적으로 어긋날 수 있음
- **과다 데이터**: 수백 회차 시 메모리/정렬 부담

### 적용 수정
- **completed 중복 제거**: `completed_sorted` 생성 시 회차별로 마지막 항목만 사용 (`round` 기준 dedupe)
- **history 상한**: 표시·계산용으로 최근 500회차만 유지 (저장은 그대로, 메모리 내 처리만 제한)

---

## 수정 파일
- `auto-betting-macro/macro_standalone.py`
