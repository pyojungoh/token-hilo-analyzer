# Railway 서버 재시작 및 환경 변수 설정 가이드

## 🚀 서버 재시작 방법

### 방법 1: 자동 재배포 (GitHub 연동 시)
1. 코드를 GitHub에 푸시하면 **자동으로 재배포**됩니다
2. Railway가 자동으로 감지하여 서버를 재시작합니다

### 방법 2: 수동 재배포
1. Railway 대시보드 접속: https://railway.app
2. 프로젝트 선택
3. **"Deployments"** 탭 클릭
4. 최신 배포 옆의 **"⋯"** (점 3개) 메뉴 클릭
5. **"Redeploy"** 선택
6. 서버가 재시작됩니다

### 방법 3: 환경 변수 변경 시 자동 재시작
- 환경 변수를 추가/수정/삭제하면 **자동으로 재배포**됩니다

## ⚙️ 환경 변수 설정 방법

### 필수 환경 변수

Railway 대시보드에서 다음 환경 변수를 설정해야 합니다:

#### 1. DATABASE_URL (필수 - 데이터베이스용)
```
변수명: DATABASE_URL
값: Railway PostgreSQL 서비스의 전체 연결 URL
```

**전체 연결 URL 형식:**
```
postgresql://사용자명:비밀번호@호스트:포트/데이터베이스명
```

**예시:**
```
postgresql://postgres:비밀번호@metro.proxy.rlwy.net:5432/railway
```

**설정 방법:**

**방법 1: Railway 자동 연결 (권장)**
1. Railway 프로젝트에서 **PostgreSQL 서비스 추가**
2. PostgreSQL 서비스를 추가하면 메인 서비스에 자동으로 연결됩니다
3. 메인 서비스 → **"Variables"** 탭에서 `DATABASE_URL` 확인
4. 이미 설정되어 있을 수 있습니다!

**방법 2: 수동 설정**
1. Railway 프로젝트에서 **PostgreSQL 서비스 선택**
2. PostgreSQL 서비스 → **"Variables"** 탭 클릭
3. `DATABASE_URL` 또는 `POSTGRES_URL` 변수 찾기
4. 전체 값을 복사 (예: `postgresql://postgres:xxx@metro.proxy.rlwy.net:5432/railway`)
5. 메인 서비스 → **"Variables"** 탭
6. **"+ New Variable"** 클릭
7. 변수명: `DATABASE_URL`
8. 값: 복사한 전체 연결 URL 붙여넣기
9. **"Add"** 클릭

**주의:**
- `metro.proxy.rlwy.net`은 호스트 주소일 뿐입니다
- 전체 연결 URL이 필요합니다 (사용자명, 비밀번호, 포트, 데이터베이스명 포함)
- Railway PostgreSQL 서비스의 Variables 탭에서 전체 URL을 확인하세요

#### 2. SOCKETIO_URL (필수)
```
변수명: SOCKETIO_URL
값: https://game.cmx258.com:8080
```

#### 3. BASE_URL (선택)
```
변수명: BASE_URL
값: http://tgame365.com
```

### 환경 변수 설정 단계별 가이드

1. **Railway 대시보드 접속**
   - https://railway.app 접속
   - 로그인

2. **프로젝트 선택**
   - 대시보드에서 프로젝트 클릭

3. **Variables 탭 클릭**
   - 왼쪽 메뉴에서 **"Variables"** 클릭

4. **환경 변수 추가**
   - **"+ New Variable"** 버튼 클릭
   - 변수명과 값 입력
   - **"Add"** 클릭

5. **자동 재배포 확인**
   - 환경 변수 추가/수정 시 자동으로 재배포됩니다
   - **"Deployments"** 탭에서 배포 상태 확인

## 📋 필수 환경 변수 체크리스트

다음 환경 변수들이 모두 설정되어 있는지 확인하세요:

- [ ] `DATABASE_URL` - PostgreSQL 데이터베이스 연결 URL
- [ ] `SOCKETIO_URL` - `https://game.cmx258.com:8080`
- [ ] `BASE_URL` (선택) - `http://tgame365.com`

**주의:**
- `PORT` 변수는 **절대 설정하지 마세요!** Railway가 자동으로 설정합니다.
- `PORT`를 수동으로 설정하면 오류가 발생합니다.

## 🔍 환경 변수 확인 방법

### Railway 로그에서 확인
1. Railway 대시보드 → 프로젝트 선택
2. **"Deployments"** 탭 → 최신 배포 클릭
3. 로그에서 다음 메시지 확인:

**정상:**
- `[✅] psycopg2 라이브러리 로드 성공`
- `[📋] DATABASE_URL 설정됨 (길이: XX 문자)`
- `[✅] 데이터베이스 연결 성공`
- `[✅] game_results 테이블 생성 완료`
- `[✅] color_matches 테이블 생성 완료`
- `[✅] 데이터베이스 테이블 초기화 완료`

**오류:**
- `[❌ 경고] DATABASE_URL 환경 변수가 설정되지 않았습니다`
- `[❌ 경고] psycopg2가 설치되지 않았습니다`
- `[❌ 오류] 데이터베이스 초기화 실패`

### API로 확인
브라우저에서 다음 URL 접속:
```
https://your-app.railway.app/api/debug/db-status
```

응답에서 다음을 확인:
- `db_available`: `true`
- `database_url_set`: `true`
- `connection`: `"success"`

## 🛠️ PostgreSQL 서비스 추가 및 DATABASE_URL 확인 방법

### PostgreSQL 서비스 추가
1. Railway 프로젝트에서 **"+ New"** 클릭
2. **"Database"** 선택
3. **"Add PostgreSQL"** 선택
4. PostgreSQL 서비스가 생성됩니다

### DATABASE_URL 확인 및 설정

**방법 1: 자동 연결 확인 (먼저 확인!)**
1. 메인 서비스 (웹 서비스) 선택
2. **"Variables"** 탭 클릭
3. `DATABASE_URL` 변수가 이미 있는지 확인
4. 있다면 이미 설정된 것입니다!

**방법 2: PostgreSQL 서비스에서 복사**
1. PostgreSQL 서비스 선택
2. **"Variables"** 탭 클릭
3. 다음 중 하나를 찾으세요:
   - `DATABASE_URL`
   - `POSTGRES_URL`
   - `POSTGRES_PRIVATE_URL`
4. 전체 연결 URL 복사 (예: `postgresql://postgres:비밀번호@metro.proxy.rlwy.net:5432/railway`)
5. 메인 서비스 → **"Variables"** 탭
6. `DATABASE_URL` 변수가 없으면 추가:
   - **"+ New Variable"** 클릭
   - 변수명: `DATABASE_URL`
   - 값: 복사한 전체 URL 붙여넣기
   - **"Add"** 클릭

**중요:**
- `metro.proxy.rlwy.net`은 호스트 주소일 뿐입니다
- 전체 연결 URL 형식: `postgresql://사용자:비밀번호@호스트:포트/DB명`
- Railway PostgreSQL Variables에서 전체 URL을 확인하세요

## ⚡ 빠른 재시작 방법

코드를 수정한 후:
1. GitHub에 푸시: `git push origin main`
2. Railway가 자동으로 재배포합니다
3. **"Deployments"** 탭에서 배포 완료 대기
4. 완료되면 자동으로 서버가 재시작됩니다

## 📝 로그 확인 방법

1. Railway 대시보드 → 프로젝트 선택
2. **"Deployments"** 탭 클릭
3. 최신 배포 클릭
4. 실시간 로그 확인

또는:
1. 프로젝트 → **"Logs"** 탭
2. 실시간 로그 스트림 확인

## ❓ 문제 해결

### 서버가 재시작되지 않을 때
1. **"Deployments"** 탭에서 배포 상태 확인
2. 빌드 오류가 있는지 확인
3. 환경 변수 설정 확인
4. 수동으로 **"Redeploy"** 클릭

### 데이터베이스 테이블이 생성되지 않을 때
1. `DATABASE_URL` 환경 변수 확인
2. Railway 로그에서 에러 메시지 확인
3. `/api/debug/init-db` (POST) 엔드포인트 호출하여 수동 생성
4. `/api/debug/db-status`로 상태 확인

### 환경 변수가 적용되지 않을 때
1. 환경 변수 저장 후 자동 재배포 대기
2. 재배포가 안 되면 수동으로 **"Redeploy"** 클릭
3. 로그에서 환경 변수 로드 메시지 확인
