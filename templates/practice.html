<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <title>매크로 연습 페이지</title>
    <style>
        * { box-sizing: border-box; }
        body { margin: 0; font-family: "Malgun Gothic", "Noto Sans KR", sans-serif; background: #1a1a2e; color: #eee; min-height: 100vh; padding: 12px; }
        h1 { font-size: 1.1em; margin: 0 0 12px; color: #64b5f6; }
        .section { background: #16213e; border-radius: 8px; padding: 12px; margin-bottom: 12px; }
        .section h2 { font-size: 0.95em; color: #aaa; margin: 0 0 8px; }
        /* 배팅 UI — 매크로가 탭하는 영역. 버튼 크기 키워서 좌표 잡기 쉽게 */
        .bet-ui { display: flex; flex-direction: column; gap: 10px; max-width: 320px; }
        .bet-ui label { font-size: 0.9em; color: #bbb; }
        .bet-ui input[type="text"] { padding: 14px 12px; font-size: 1.1em; background: #0d0d0d; border: 2px solid #37474f; border-radius: 6px; color: #fff; }
        .bet-ui input:focus { border-color: #64b5f6; outline: none; }
        .bet-buttons { display: flex; gap: 10px; flex-wrap: wrap; }
        .bet-btn { padding: 16px 24px; font-size: 1.05em; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; min-width: 100px; }
        .bet-btn.red { background: #b71c1c; color: #fff; }
        .bet-btn.black { background: #212121; color: #fff; }
        .bet-btn.confirm { background: #0f3460; color: #64b5f6; border: 1px solid #64b5f6; }
        .bet-btn:hover { opacity: 0.9; }
        /* 분석기 현재 픽 (연습 시 참고) */
        .analyzer-pick { font-size: 1.1em; margin: 6px 0; }
        .analyzer-pick .color { font-weight: bold; }
        .analyzer-pick .color.red { color: #e57373; }
        .analyzer-pick .color.black { color: #90a4ae; }
        .analyzer-pick .amount { color: #81c784; margin-left: 8px; }
        /* 액션 로그 — 마틴 확인용 */
        .log-box { background: #0d0d0d; border: 1px solid #333; border-radius: 6px; padding: 10px; max-height: 220px; overflow-y: auto; font-family: monospace; font-size: 0.85em; line-height: 1.5; color: #b0b0b0; }
        .log-box .line { margin: 2px 0; }
        .log-box .line.amount { color: #81c784; }
        .log-box .line.red { color: #e57373; }
        .log-box .line.black { color: #90a4ae; }
        .log-box .line.confirm { color: #64b5f6; }
        .log-box .line.win { color: #81c784; font-weight: bold; }
        .log-box .line.lose { color: #e57373; font-weight: bold; }
        .log-box .line.joker { color: #ffb74d; }
        .hint { font-size: 0.8em; color: #888; margin-top: 8px; }
        /* 배팅 현황 — 진짜 배팅 프로그램처럼 */
        .bet-summary { display: flex; flex-wrap: wrap; gap: 12px 20px; align-items: center; padding: 12px 14px; background: linear-gradient(135deg, #0d1b2a 0%, #1b263b 100%); border: 1px solid #37474f; border-radius: 8px; margin-bottom: 12px; }
        .bet-summary-item { display: flex; align-items: baseline; gap: 6px; }
        .bet-summary-item .label { font-size: 0.85em; color: #78909c; }
        .bet-summary-item .value { font-size: 1.1em; font-weight: 600; color: #eceff1; }
        .bet-summary-item .value.profit-plus { color: #81c784; }
        .bet-summary-item .value.profit-minus { color: #e57373; }
        .bet-summary-item input { width: 100px; padding: 6px 8px; font-size: 0.95em; background: #0d0d0d; border: 1px solid #37474f; border-radius: 4px; color: #fff; }
        .bet-summary .btn-reset { padding: 6px 12px; font-size: 0.85em; background: #37474f; color: #b0bec5; border: none; border-radius: 4px; cursor: pointer; }
        .bet-summary .btn-reset:hover { background: #455a64; color: #fff; }
    </style>
</head>
<body>
    <h1>자동배팅 매크로 연습 페이지</h1>
    <p class="hint">에뮬레이터 브라우저에서 이 페이지를 열고, 매크로에서 좌표 찾기로 배팅금액·RED·BLACK·정정을 잡은 뒤 시작하면 됩니다. 아래 로그로 마틴 금액이 잘 들어가는지 확인하세요. 계산기 2/3 테스트는 주소에 ?calculator=2 또는 ?calculator=3 을 붙이면 됩니다.</p>

    <div class="section">
        <h2>배팅 현황</h2>
        <div class="bet-summary">
            <div class="bet-summary-item">
                <span class="label">시작자본</span>
                <input type="number" id="initial-capital" value="1000000" min="1000" step="1000" title="시작 자본 (원)" />
                <span class="value">원</span>
            </div>
            <div class="bet-summary-item">
                <span class="label">보유자산</span>
                <span class="value" id="current-capital">1,000,000</span>
                <span>원</span>
            </div>
            <div class="bet-summary-item">
                <span class="label">순익</span>
                <span class="value" id="profit-display">0</span>
                <span>원</span>
            </div>
            <div class="bet-summary-item">
                <span class="label">배팅중</span>
                <span class="value" id="betting-amount">—</span>
            </div>
            <button type="button" class="btn-reset" id="btn-reset">리셋</button>
        </div>
    </div>

    <div class="section">
        <h2>분석기 현재 픽 (참고)</h2>
        <div id="analyzer-pick" class="analyzer-pick">— 로딩 중</div>
        <div id="analyzer-meta" style="font-size:0.85em;color:#888;">—</div>
        <div id="recent-results" style="font-size:0.85em;color:#888;margin-top:6px;">최근 결과: —</div>
        <a href="/api/betting-history-export" style="display:inline-block;margin-top:8px;padding:6px 12px;background:#0f3460;color:#64b5f6;border:1px solid #64b5f6;border-radius:4px;text-decoration:none;font-size:0.85em;">엑셀 다운로드 (배팅이력)</a>
        <label style="display:block;margin-top:8px;font-size:0.85em;color:#888;">매크로 푸시 주소 (빠른 배팅용, 에뮬: http://10.0.2.2:8765)</label>
        <input type="text" id="push-url" placeholder="http://10.0.2.2:8765 또는 비움" style="width:100%;max-width:280px;padding:8px;margin-top:4px;background:#0d0d0d;border:1px solid #37474f;border-radius:4px;color:#fff;font-size:0.9em;" />
    </div>

    <div class="section">
        <h2>배팅 UI (매크로가 탭하는 영역)</h2>
        <div class="bet-ui">
            <label for="bet-amount">배팅금액</label>
            <input type="text" id="bet-amount" inputmode="numeric" placeholder="금액 입력" autocomplete="off" />
            <div class="bet-buttons">
                <button type="button" class="bet-btn red" id="btn-red">RED</button>
                <button type="button" class="bet-btn black" id="btn-black">BLACK</button>
                <button type="button" class="bet-btn confirm" id="btn-confirm">정정</button>
            </div>
        </div>
    </div>

    <div class="section">
        <h2>액션 로그 (마틴 확인용)</h2>
        <div class="log-box" id="log-box"></div>
        <p class="hint">금액 입력·RED/BLACK·정정 시 로그가 쌓입니다. 정정 후 해당 회차 결과가 나오면 승/패/조커가 로그에 표시됩니다.</p>
    </div>

    <script>
(function() {
        var logBox = document.getElementById('log-box');
        var betAmount = document.getElementById('bet-amount');
        var analyzerPick = document.getElementById('analyzer-pick');
        var analyzerMeta = document.getElementById('analyzer-meta');
        var recentResultsEl = document.getElementById('recent-results');
        var initialCapitalEl = document.getElementById('initial-capital');
        var currentCapitalEl = document.getElementById('current-capital');
        var profitDisplayEl = document.getElementById('profit-display');
        var bettingAmountEl = document.getElementById('betting-amount');

        var ODDS = 1.97;
        var initialCapital = 1000000;
        var currentCapital = 1000000;

        function updateBetSummaryDisplay() {
            var profit = currentCapital - initialCapital;
            currentCapitalEl.textContent = currentCapital.toLocaleString();
            profitDisplayEl.textContent = (profit >= 0 ? '+' : '') + profit.toLocaleString();
            profitDisplayEl.className = 'value' + (profit > 0 ? ' profit-plus' : (profit < 0 ? ' profit-minus' : ''));
        }
        function setInitialCapital() {
            var v = parseInt(initialCapitalEl.value, 10);
            if (!isNaN(v) && v >= 1000) {
                initialCapital = v;
                currentCapital = v;
                updateBetSummaryDisplay();
            }
        }
        document.getElementById('btn-reset').addEventListener('click', function() {
            setInitialCapital();
            addLog('리셋 — 자본 ' + initialCapital.toLocaleString() + '원으로 초기화', 'confirm');
        });
        initialCapitalEl.addEventListener('change', setInitialCapital);
        setInitialCapital();  // 페이지 로드 시 입력값으로 초기화

        function nowStr() {
            var d = new Date();
            return d.getHours() + ':' + String(d.getMinutes()).padStart(2,'0') + ':' + String(d.getSeconds()).padStart(2,'0');
        }
        function addLog(text, className) {
            var line = document.createElement('div');
            line.className = 'line' + (className ? ' ' + className : '');
            line.textContent = '[' + nowStr() + '] ' + text;
            logBox.appendChild(line);
            logBox.scrollTop = logBox.scrollHeight;
        }

        betAmount.addEventListener('input', function() {
            var v = this.value.replace(/\D/g, '');
            if (this.value !== v) this.value = v;
            if (v.length > 0) addLog('금액 입력: ' + (v ? parseInt(v, 10).toLocaleString() + '원' : '(비움)'), 'amount');
        });
        betAmount.addEventListener('focus', function() {
            this.value = '';
            addLog('배팅금액 포커스 (내용 비움)', 'amount');
        });

        document.getElementById('btn-red').addEventListener('click', function() {
            addLog('RED 클릭', 'red');
        });
        document.getElementById('btn-black').addEventListener('click', function() {
            addLog('BLACK 클릭', 'black');
        });
        var pendingBetsByRound = {};  // round -> { pick, amount } — 결과 대기
        document.getElementById('btn-confirm').addEventListener('click', function() {
            var amt = betAmount.value.replace(/\D/g, '') || '0';
            var amtNum = parseInt(amt, 10) || 0;
            var pickData = null;
            try {
                var color = (analyzerPick.querySelector('.color') || {}).textContent || '';
                pickData = (color.toUpperCase() === 'RED' || color === '빨강') ? '정' : (color.toUpperCase() === 'BLACK' || color === '검정') ? '꺽' : null;
            } catch (e) {}
            addLog('정정 클릭 | 금액: ' + amtNum.toLocaleString() + '원', 'confirm');
            bettingAmountEl.textContent = amtNum > 0 ? amtNum.toLocaleString() + '원' : '—';
            if (pickData && typeof lastAnalyzerRound !== 'undefined' && lastAnalyzerRound != null && amtNum > 0) {
                pendingBetsByRound[lastAnalyzerRound] = { pick: pickData, amount: amtNum };
            }
        });

        var calcId = 1;
        try {
            var m = /calculator=([123])/.exec(location.search);
            if (m) calcId = parseInt(m[1], 10);
        } catch (e) {}
        var lastPushedKey = null;
        var lastAnalyzerRound = null;
        function pollAnalyzerPick() {
            fetch('/api/current-pick-relay?calculator=' + calcId, { cache: 'no-cache' }).then(function(r) { return r.json(); }).then(function(data) {
                var color = data.pick_color || data.pickColor;
                var round = data.round;
                var amt = data.suggested_amount != null ? data.suggested_amount : (data.suggestedAmount != null ? data.suggestedAmount : null);
                var run = data.running;
                if (color) {
                    var c = (color + '').toUpperCase();
                    var isRed = c === 'RED' || color === '빨강';
                    lastAnalyzerRound = round;
                    analyzerPick.innerHTML = '<span class="color ' + (isRed ? 'red' : 'black') + '">' + (isRed ? 'RED' : 'BLACK') + '</span>' +
                        (amt != null && amt > 0 ? '<span class="amount">' + Number(amt).toLocaleString() + '원</span>' : '');
                    analyzerMeta.textContent = '계산기 ' + calcId + ' | 회차: ' + (round != null ? round : '—') + (run === false ? ' | 정지' : '');
                    if (Object.keys(pendingBetsByRound).length === 0 && amt != null && amt > 0) {
                        bettingAmountEl.textContent = Number(amt).toLocaleString() + '원';
                    }
                    var pushUrl = (document.getElementById('push-url') || {}).value;
                    if (pushUrl && round != null && color && amt != null && amt > 0 && run !== false) {
                        var key = round + '|' + color + '|' + amt;
                        if (key !== lastPushedKey) {
                            lastPushedKey = key;
                            fetch((pushUrl.replace(/\/$/, '')) + '/push-pick', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ round: round, pick_color: color, suggested_amount: amt })
                            }).catch(function() {});
                        }
                    } else if (!pushUrl) lastPushedKey = null;
                } else {
                    analyzerPick.textContent = '— 픽 없음';
                    analyzerMeta.textContent = run === false ? '계산기 정지' : '대기 중';
                    lastPushedKey = null;
                    if (Object.keys(pendingBetsByRound).length === 0) bettingAmountEl.textContent = '—';
                }
            }).catch(function() {
                analyzerPick.textContent = '— API 연결 실패 (같은 도메인에서 열어야 함)';
                analyzerMeta.textContent = '';
            });
        }
        pollAnalyzerPick();
        setInterval(pollAnalyzerPick, 500);
        function pollRecentResults() {
            fetch('/api/betting-helper-data', { cache: 'no-cache' }).then(function(r) { return r.json(); }).then(function(data) {
                var results = data.recent_results || [];
                if (results.length > 0) {
                    var parts = results.slice(0, 5).map(function(r) { return r.round + '회 ' + r.result; });
                    recentResultsEl.textContent = '최근 결과: ' + parts.join(', ');
                    // 정정 클릭 후 해당 회차 결과 나오면 액션 로그에 승/패 표시 및 자본 반영
                    results.forEach(function(r) {
                        var rnd = r.round;
                        var pending = pendingBetsByRound[rnd];
                        if (!pending) return;
                        var res = (r.result || '').trim();
                        var betAmt = pending.amount || 0;
                        delete pendingBetsByRound[rnd];
                        if (res === '승') {
                            var winAmt = Math.floor(betAmt * (ODDS - 1));
                            currentCapital += winAmt;
                            addLog(rnd + '회 결과: 승 (+' + winAmt.toLocaleString() + '원)', 'win');
                        } else if (res === '패') {
                            currentCapital -= betAmt;
                            addLog(rnd + '회 결과: 패 (-' + betAmt.toLocaleString() + '원)', 'lose');
                        } else {
                            currentCapital -= betAmt;
                            addLog(rnd + '회 결과: 조커 (-' + betAmt.toLocaleString() + '원)', 'joker');
                        }
                    });
                    var pendingCnt = Object.keys(pendingBetsByRound).length;
                    bettingAmountEl.textContent = pendingCnt > 0 ? '대기중 (' + pendingCnt + '건)' : '—';
                    updateBetSummaryDisplay();
                } else {
                    recentResultsEl.textContent = '최근 결과: —';
                }
            }).catch(function() { recentResultsEl.textContent = '최근 결과: —'; });
        }
        pollRecentResults();
        setInterval(pollRecentResults, 3000);
})();
    </script>
</body>
</html>
